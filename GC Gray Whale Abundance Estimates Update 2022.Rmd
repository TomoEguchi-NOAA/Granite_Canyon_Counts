---
title: "Gray whale abundance estimates update (2022)"
author: "Tomo Eguchi"
date: "`r Sys.Date()`"
output: 
  bookdown::word_document2: default
---

```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
save.fig <- T

source("Granite_Canyon_Counts_fcns.R")
library(tidyverse)
library(lubridate)
library(flextable)

set_flextable_defaults(font.size = 9,
                       font.family = "Cambria")
# some constants here:
# # periods for the 6 survey years
periods <-c(136, 135, 164, 178, 179, 151)

# Observer list gets updated as new observers are added. 
obs.list <- read.csv("Data/Observer list.csv", header = T) 
colnames(obs.list) <- c("obs", "ID")


```

## Introduction {-}

In this document, I provide the estimated abundance of gray whales from the data collected at Granite Canyon, CA. I used the same statistical model (N-mixture model; Durban et al. 2016) as in the previous years (e.g., Stewart and Weller 2021). While conducting quality assurance of the data, I found some discrepancies between raw data files and summarized data. The discrepancies were caused by the data extraction scripts written in the R statistical language. Consequently, I modified the script files. I first explain why and how I modified the script files. I will show all instances in which the data were incompletely extracted and how they were corrected in the modified script. I then provide abundance estimates from summary statistics obtained by using the original and modified data extraction scripts. Although the differences in resulting abundance estimates were minor, I think it is prudent to document the changes over the years so that the next analyst will have sufficient knowledge to explain the entire process of data analyses, which includes data extraction and model fitting. 

## Why {-}
Because of minor differences in the data file format before and after the 2020 season, Josh Stewart modified the script file that was developed by John Durban for earlier years; the Ver1.0 extraction scripts, or Ver1.0 hereafter. However, the new version of R (V.4) has apparently changed how the "read.table" function reads text files. Consequently, the script file for data files prior to the 2020 season no longer functions properly. Furthermore, when I examined the input and output files from the extraction script for the 2020 season, I found some minor discrepancies (detailed below). Consequently, I decided to make a script file that can be used to read pre- and post-2020 season data to simplify the data extraction process; the Ver2.0 extraction script or Ver2.0, hereafter. 

While creating the new extraction script, I found that it is important to have an "End survey" line (event code 'E') at the end of each data file. I also found that some data were included in the analysis even though they came from shifts that lasted less than 85 minutes. These modifications should be recorded somewhere for reproducibility. In addition, some data lines missed expected information, such as a Beaufort sea state and visibility, resulting in dropped sightings. It is advisable to create a data checking script so that these errors can be fixed at the end of each survey day. (I think I can do that relatively easily before the next survey.) Finally, extensive comments should be made only with the "C" event, not with others (i.e., B, V, S, P, and E).

In the following, I provide explanations about the differences in outputs from Ver1.0 and Ver2.0 for four survey seasons that I have raw data (2015, 2016, 2020, and 2022).

## How {-}
One difference between Ver1.0 and Ver2.0 is how each shift was determined. In Ver1.0, start and end of shifts were determined using the following line (V2 is event code):

    Shifts <- which(data$V2 %in% c('P','E')) 

In other words, beginning and end of each shift were events "P" or "E." This works if there was a "P" or "E" at the end of a data file. If there was no "P" or "E" at the end (it has happened), the last shift is completely dropped from data extraction.  

This was replaced by the following code: 

    Shifts.begin <- which(data$V2 %in% "P")
    Shifts.begin.df <- data.frame(event = "P",
                                shift = 1:length(Shifts.begin),
                                row = Shifts.begin)
    Shifts.end <- which(data$V2 %in% "E")
      Shifts.end.df <- data.frame(event = "E",
                              shift = NA,
                              row = Shifts.end)
    Shifts.df <- arrange(rbind(Shifts.begin.df, Shifts.end.df), row)

This modification assertained that all shifts were included.

Another difference is that I added seconds to define beginning and end of each shift. In Ver1.0, time was defined using only hours and minutes:

    NextBeginHr <- (hour(hms(data[Shifts[i+1],4])) + 
                    (minute(hms(data[Shifts[i+1],4]))/60)

In some occasions, the last sighting of a shift and the following shift started within a minute, causing the last sighting to be dropped (e.g., file 41, 2020-02-04. See below). Consequently, I added seconds to each line that calculates decimal hours. 

    BeginHr <- (hour(hms(data[Shifts.begin[i], 4])) + 
                (minute(hms(data[Shifts.begin[i], 4]))/60) 
              + (second(hms(data[Shifts.begin[i], 4]))/3600))
  
The new version (Ver2.0) contains two functions: one to extract data from a file ("get.data") and another to extract each shift ("get.shift"). The get.data function requires three inputs; a directory name, a survey year, and the sequential number of a file (ordered alphanumerically) within the directory. The get.shift function requires four inputs; a survey year, output data from the get.data function, the sequential number of a file in the directory, and the shift identification number. These functions are used in a script file named "Extract_Data_All_v2.Rmd," in which all data files in a directory for a survey year are read, data extracted, and summarized for abundance estimation. It is assumed in these functions that there are directories that contain data files for each survey seasons and they are named by the season, e.g., Data/2020. 

## Discrepancies {-}
In this section, I explain each discrepancy between Ver1.0 and Ver2.0 outputs for each season (2015, 2016, 2020, and 2022). Some discrepancies were not explainable. 

### 2015 {-}
For the 2015 and 2016 seasons, I was unable to compare data extraction methods using Ver1.0 because it no longer functioned properly due to the change in R's read.table function. The error was caused by how data columns were aligned. Consequently, I compared the summarized data, which were already extracted for abundance estimation, to the output from Ver2.0. 

The summarized data contained surveys from 2006/2007 (2007 data), 2007/2008 (2008 data), 2009/2010 (2010 data), 2010/2011 (2011 data), 2014/2015 (2015 data), 2015/2016 (2016 data), and 2019/2020 (2020 data). So, this dataset (2015 data) should be the 5th. The year information should be explicitly included in the data. 

```{r Compare-2015, error=FALSE, warning=FALSE, include=FALSE}
# this is for the 5th data set in the analysis (2015)
YEAR <- 2015
FILES <- list.files(paste0("Data/", YEAR, "/"))
idx.yr <- 5

out.list <- compare.V0.V2.BUGSinput(YEAR, idx.yr, periods, obs.list)

```


There were `r nrow(out.list$difs.1)` difference in the number of whales detected or the number of sampling shifts per day. Look at one at a time to see what made the difference. This was completed in "compare_v0_v2_2015.Rmd" and its contents are explained fully here. 

#### (1) `r fractional_Day2YMDhms(out.list$difs.1[1,"begin"], YEAR)$YMD` {-}

```{r dif-2015-1, warning=FALSE, include=FALSE, error=FALSE}
idx <- 1
YMD <- fractional_Day2YMDhms(out.list$difs.1[idx,"begin"], YEAR)$YMD

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V0") -> tmp.V0

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V2") -> tmp.V2

comp.table <- n.comparison(out.list$FinalData.Both, out.list$difs.1, idx, YEAR)

# All data before removing too short/long and too high Beaufort/VS. 
out.list$Data_Out.v2 %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"])  -> Data_Out.v2.tmp

FF <- Data_Out.v2.tmp[1, "ff"]
data <- get.data("Data/", YEAR, ff = FF)

shift <- 5
out.shift <- get.shift(YEAR, data, ff=FF, i=shift)

# data %>% 
#   filter(begin >= Data_Out.v2.tmp[shift,"begin"] & 
#            begin <= Data_Out.v2.tmp[shift, "end"]) %>%
#   filter(V2 == "S") %>%
#   select(V5, V9) %>%
#   mutate(V5 = as.numeric(V5), V9 = as.numeric(V9)) %>%
#   group_by(V5) %>%
#   summarize(n = last(V9)) -> summary.data

# Extract data using the begin-end times for V0 and V2, which are a little
# different because of including seconds in V2 - this is not the cause of the
# difference.
data %>% 
  filter(begin >= tmp.V0[4,"begin"] & begin <= tmp.V0[4, "end"]) %>%
  filter(V2 == "S") %>%
  select(V5, V9) %>%
  mutate(V5 = as.numeric(V5), V9 = as.numeric(V9)) %>%
  group_by(V5) %>%
  summarize(n = last(V9)) -> summary.V0

data %>% 
  filter(begin >= tmp.V2[4,"begin"] & begin <= tmp.V2[4, "end"]) %>%
  filter(V2 == "S") %>%
  select(V5, V9) %>%
  mutate(V5 = as.numeric(V5), V9 = as.numeric(V9)) %>%
  group_by(V5) %>%
  summarize(n = last(V9)) -> summary.V2

```

The first inconsistency was found for `r fractional_Day2YMDhms(out.list$difs.1[idx, "begin"], YEAR)$YMD` (Table \@ref(tab:Table-dif-2015-1)). There were `r abs(out.list$difs.1[idx, "total.whales"])` more whales in `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver2.0", "Ver1.0")` than in `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver1.0", "Ver2.0")`. 

There was a total of `r nrow(Data_Out.v2.tmp)` shifts on `r fractional_Day2YMDhms(out.list$difs.1[idx, "begin"], YEAR)$YMD`. During the third shift (`r fractional_Day2YMDhms(Data_Out.v2.tmp[3, "begin"], YEAR)$hms` to `r fractional_Day2YMDhms(Data_Out.v2.tmp[3, "end"], YEAR)$hms`), the maximum Beaufort sea state was `r Data_Out.v2.tmp[3, "bf"]`. Consequently, the shift was removed from further analyses. 

Comparing the two outputs for the remaining four shifts, there were 3 more whales recorded in the last (fifth) shift (from `r fractional_Day2YMDhms(tmp.V2[4, "begin"], YEAR)$hms` to `r fractional_Day2YMDhms(tmp.V2[4, "end"], YEAR)$hms`) of the day from Ver2.0 (n = `r tmp.V2[4, "n"]`) than from Ver1.0 (n = `r tmp.V0[4, "n"]`; Table \@ref(tab:Table-dif-2015-1)). Because I did not have access to the intermediate steps of the data extraction process, I could not determine what made the difference. 


```{r Table-dif-2015-1, echo=FALSE, warning=FALSE}
flextable(comp.table) %>% 
  hline(i = (nrow(comp.table)-1)) %>%
 set_caption(paste0("A comparison of results of data extraction for ", YMD, " using Ver1.0 and Ver2.0. n.XXX is the number of observed whales, vs.XXX is the visibility, and Bf.XXX is the Beaufort scale, where XXX is either Ver1.0 or Ver2.0. Beginning time (begin.time) for each shift may be different between Ver1.0 and Ver2.0 because Ver1.0 did not use seconds to determine the beginning and end of each shift, whereas Ver2.0 used the entire information. Each shift may be split in two lines if the start time (begin.time) is not exactly the same.")) %>%
  set_table_properties(width = 0.5, layout = "autofit")

```


#### (2) `r fractional_Day2YMDhms(out.list$difs.1[2,"begin"], YEAR)$YMD`{-}

```{r dif-2015-2, warning=FALSE, include=FALSE, error=FALSE}
idx <- 2
YMD <- fractional_Day2YMDhms(out.list$difs.1[idx,"begin"], YEAR)$YMD

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V0") -> tmp.V0

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V2") -> tmp.V2

comp.table <- n.comparison(out.list$FinalData.Both, out.list$difs.1, idx, YEAR)

# comparing tmp.V0 and tmp.V2 results in 3 more whales in the last shift (6)
# V0 = 25 and V2 = 28

# All data before removing too short/long and too high Beaufort/VS. 
out.list$Data_Out.v2 %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"])  -> Data_Out.v2.tmp

# output shows the file id is 9
FF <- Data_Out.v2.tmp[1, "ff"]
data <- get.data("Data/", YEAR, ff = FF)

shift <- 6
out.shift <- get.shift(YEAR, data, ff=FF, i=shift)

data %>% 
  filter(begin >= Data_Out.v2.tmp[shift,"begin"] & 
           begin <= Data_Out.v2.tmp[shift, "end"]) %>%
  filter(V2 == "S") %>%
  select(V5, V9) %>%
  mutate(V5 = as.numeric(V5), V9 = as.numeric(V9)) %>%
  group_by(V5) %>%
  summarize(n = last(V9)) -> summary.data

# V0
data %>% 
  filter(begin >= tmp.V0[shift,"begin"] & begin <= tmp.V0[shift, "end"]) %>%
  filter(V2 == "S") %>%
  select(V5, V9) %>%
  mutate(V5 = as.numeric(V5), V9 = as.numeric(V9)) %>%
  group_by(V5) %>%
  summarize(n = last(V9)) -> summary.V0

# V2
data %>% 
  filter(begin >= tmp.V2[shift,"begin"] & begin <= tmp.V2[shift, "end"]) %>%
  filter(V2 == "S") %>%
  select(V5, V9) %>%
  mutate(V5 = as.numeric(V5), V9 = as.numeric(V9)) %>%
  group_by(V5) %>%
  summarize(n = last(V9)) -> summary.V2

last.rows <- tail(out.shift$data.shift) %>% select(-c(V15, V16, begin))
```


The second inconsistency was found for `r fractional_Day2YMDhms(out.list$difs.1[idx, "begin"], YEAR)$YMD`. There were `r abs(out.list$difs.1[idx, "total.whales"])` more whales in the output from `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver2.0", "Ver1.0")` than in the output from `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver1.0", "Ver2.0")` (Table \@ref(tab:Table-dif-2015-2)). 


```{r Table-dif-2015-2, echo=FALSE, warning=FALSE}
flextable(comp.table) %>% 
  hline(i = (nrow(comp.table)-1)) %>%
 set_caption(paste0("A comparison of results of data extraction for ", YMD, " using Ver1.0 and Ver2.0. n.XXX is the number of observed whales, vs.XXX is the visibility, and Bf.XXX is the Beaufort scale, where XXX is either Ver1.0 or Ver2.0. Beginning time (begin.time) for each shift may be different between Ver1.0 and Ver2.0 because Ver1.0 did not use seconds to determine the beginning and end of each shift, whereas Ver2.0 used the entire information. Each shift may be split in two lines if the start time (begin.time) is not exactly the same.")) %>%
  set_table_properties(width = 0.5, layout = "autofit")

```

The difference for this data file came from the lack of seconds in the end time, where the end time for the last shift was `r fractional_Day2YMDhms(tmp.V0[6, "end"], YEAR)$hms`. Consequently, the last sighting, which occurred at `r out.shift$data[nrow(out.shift$data), "V4"] ` was omitted from the Ver1.0 data extraction (Table \@ref(tab:Table-data-2015-2)).   


```{r Table-data-2015-2, echo=FALSE, warning=FALSE}
flextable(last.rows) %>% 
  set_caption(paste0("The last six rows of raw data for ", YMD, ", where V1 = event ID, V2 = event code (S = sighting, E = end of shift), V3 = date, V4 = time, V5 = gropu ID, V6 = compass bearing, V7 = reticles, V8 = distance in nm, V9 = group size, V10 = primary observer, V11 = secondary observer, V12 = Beaufort scale, V13  = visibility code, V14 = direction of movement.")) %>%
  set_table_properties(width = 0.5, layout = "autofit")
```

#### (3) `r fractional_Day2YMDhms(out.list$difs.1[3,"begin"], YEAR)$YMD` {-}

```{r dif-2015-3, warning=FALSE, include=FALSE, error=FALSE}
idx <- 3
YMD <- fractional_Day2YMDhms(out.list$difs.1[idx,"begin"], YEAR)$YMD

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V0") -> tmp.V0

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V2") -> tmp.V2

comp.table <- n.comparison(out.list$FinalData.Both, out.list$difs.1, idx, YEAR)

out.list$Data_Out.v2 %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"])  -> Data_Out.v2.tmp

FF <- Data_Out.v2.tmp[1, "ff"]
data <- get.data("Data/", YEAR, ff = FF)

shift <- 2
out.shift <- get.shift(YEAR, data, ff=FF, i=shift)

data %>% 
  filter(begin >= Data_Out.v2.tmp[shift,"begin"] & 
           begin <= Data_Out.v2.tmp[shift, "end"]) %>%
  filter(V2 == "S") %>%
  select(V5, V9) %>%
  mutate(V5 = as.numeric(V5), V9 = as.numeric(V9)) %>%
  group_by(V5) %>%
  summarize(n = last(V9)) -> summary.data

last.raws <- tail(out.shift$data.shift) %>% 
  select(-c(V15, V16, begin))
```


The third inconsistency was found for `r fractional_Day2YMDhms(out.list$difs.1[idx, "begin"], YEAR)$YMD`. There were `r abs(out.list$difs.1[idx, "total.whales"])` more whales in `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver2.0", "Ver1.0")` than in `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver1.0", "Ver2.0")` (Table \@ref(tab:Table-dif-2015-3a)). 

```{r Table-dif-2015-3a, echo=FALSE, warning=FALSE}
flextable(comp.table) %>%
  hline(i = (nrow(comp.table)-1)) %>%
  set_caption(paste0("A comparison of results of data extraction for ", YMD, " using Ver1.0 and Ver2.0. n.XXX is the number of observed whales, vs.XXX is the visibility, and BF.XXX is the Beaufort scale, where XXX is either Ver1.0 or Ver2.0. Beginning time (begin.time) for each shift may be different between Ver1.0 and Ver2.0 because Ver1.0 did not use seconds to determine the beginning and end of each shift, whereas Ver2.0 used the entire information. Each shift may be split in two lines if the start time (begin.time) is not exactly the same."))
```


The second shift (from `r fractional_Day2YMDhms(tmp.V2[2, "begin"], YEAR)$hms` to `r fractional_Day2YMDhms(tmp.V2[2, "end"], YEAR)$hms`) was eliminated in the output from Ver1.0. This was caused by Beaufort and visibility code changing to 5s at the very end of the watch period (within 30 seconds from the end; Table \@ref(tab:Table-dif-2015-3)). I think this period should be retained. The new version (Ver2.0) determines when BF and VS codes changed within a shift, where a shift was retained if either or both code changed to unacceptable levels within 5 minutes of the end of the shift.  

```{r Table-dif-2015-3, echo=FALSE, warning=FALSE}
flextable(last.raws) %>%
  set_caption(paste0("The last six rows of the raw data for the ", shift, 
                     "nd shift on ", 
                     fractional_Day2YMDhms(out.list$difs.1[idx, "begin"],
                                           YEAR)$YMD, 
                     ". Beaufort and visibility changed to 5s at ",
                     fractional_Day2YMDhms(out.shift$data.shift[17, "begin"], 
                                           YEAR)$hms, ", where V1 = event ID, V2 = event code (S = sighting, E = end of shift), V3 = date, V4 = time, V5 = gropu ID, V6 = compass bearing, V7 = reticles, V8 = distance in nm, V9 = group size, V10 = primary observer, V11 = secondary observer, V12 = Beaufort scale, V13  = visibility code, V14 = direction of movement when V2 = 'S', V5 = Beaufort scale and V6 = visibility code when V2 = 'V'.")) %>%
  set_table_properties(width = 0.5, layout = "autofit")
```

#### (4) `r fractional_Day2YMDhms(out.list$difs.1[4,"begin"], YEAR)$YMD` {-}

```{r dif-2015-4, warning=FALSE, include=FALSE, error=FALSE}
idx <- 4
YMD <- fractional_Day2YMDhms(out.list$difs.1[idx,"begin"], YEAR)$YMD

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V0") -> tmp.V0

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V2") -> tmp.V2

comp.table <- n.comparison(out.list$FinalData.Both, out.list$difs.1, idx, YEAR)

# All data before removing too short/long and too high Beaufort/VS. 
out.list$Data_Out.v2 %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"])  -> Data_Out.v2.tmp

FF <- Data_Out.v2.tmp[1, "ff"]
data <- get.data("Data/", YEAR, ff = FF)

shift <- 2
out.shift <- get.shift(YEAR, data, ff=FF, i=shift)

data %>% 
  filter(begin >= Data_Out.v2.tmp[shift,"begin"] & 
           begin <= Data_Out.v2.tmp[shift, "end"]) %>%
  filter(V2 == "S") %>%
  select(V5, V9) %>%
  mutate(V5 = as.numeric(V5), V9 = as.numeric(V9)) %>%
  group_by(V5) %>%
  summarize(n = last(V9)) -> summary.data

```


The fourth inconsistency was found for `r fractional_Day2YMDhms(out.list$difs.1[idx, "begin"], YEAR)$YMD`. This file (`r FILES[FF]`) contained the following problem first. The first shift started at 7:30:36 and ended 10:26:44, which was too long for a typical shift. There should have been a shift change at 9 a.m., which was not recorded. I fixed this error and a new file was created with _TE added to the file name.

After correcting the above error, one more shift with `r abs(out.list$difs.1[idx, "total.whales"])` whales was found in the output from Ver2.0, which was excluded in that from Ver1.0 (Table \@ref(tab:Table-dif-2015-4)). The shift started at `r fractional_Day2YMDhms(tmp.V2[2, "begin"], YEAR)$hms` and ended at `r fractional_Day2YMDhms(tmp.V2[2, "end"], YEAR)$hms`. This omission was caused by the above data entry error where the first shift was too long and was excluded in the data extraction process. 

```{r Table-dif-2015-4, echo=FALSE, warning=FALSE}
flextable(comp.table) %>%
  hline(i = (nrow(comp.table)-1)) %>%
  set_caption(paste0("A comparison of results of data extraction for ", YMD, " using Ver1.0 and Ver2.0. n.XXX is the number of observed whales, vs.XXX is the visibility, and BF.XXX is the Beaufort scale, where XXX is either Ver1.0 or Ver2.0. Beginning time (begin.time) for each shift may be different between Ver1.0 and Ver2.0 because Ver1.0 did not use seconds to determine the beginning and end of each shift, whereas Ver2.0 used the entire information. Each shift may be split in two lines if the start time (begin.time) is not exactly the same.")) %>%
  set_table_properties(width = 0.5, layout = "autofit")
```


#### (5) `r fractional_Day2YMDhms(out.list$difs.1[5,"begin"], YEAR)$YMD` {-}

```{r dif-2015-5, warning=FALSE, include=FALSE, error=FALSE}
idx <- 5
YMD <- fractional_Day2YMDhms(out.list$difs.1[idx,"begin"], YEAR)$YMD

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V0") -> tmp.V0

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V2") -> tmp.V2

comp.table <- n.comparison(out.list$FinalData.Both, out.list$difs.1, idx, YEAR)

# All data before removing too short/long and too high Beaufort/VS. 
out.list$Data_Out.v2 %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"])  -> Data_Out.v2.tmp

FF <- Data_Out.v2.tmp[1, "ff"]
data <- get.data("Data/", YEAR, ff = FF)

shift <- 2
out.shift.1 <- get.shift(YEAR, data, ff=FF, i=1)
out.shift.2 <- get.shift(YEAR, data, ff=FF, i=2)

out.shift$data %>% 
  select(V5, V9) %>%
  mutate(V5 = as.numeric(V5), V9 = as.numeric(V9)) %>%
  group_by(V5) %>%
  summarize(n = last(V9)) -> summary.data.V2

data %>% 
  filter(begin >= Data_Out.v2.tmp[shift,"begin"] & 
           begin <= Data_Out.v2.tmp[shift, "end"]) %>%
  filter(V2 == "S") %>%
  select(V5, V9) %>%
  mutate(V5 = as.numeric(V5), V9 = as.numeric(V9)) %>%
  group_by(V5) %>%
  summarize(n = last(V9)) -> summary.data

first.rows <- head(data, 8) %>% select(-c(V15:begin))
```


The fifth inconsistency was found for `r fractional_Day2YMDhms(out.list$difs.1[idx, "begin"], YEAR)$YMD` (`r FILES[FF]`). There were `r abs(out.list$difs.1[idx, "total.whales"])` more whales in `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver2.0", "Ver1.0")` than in `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver1.0", "Ver2.0")` (Table \@ref(tab:Table-dif-2015-5)). 

```{r Table-dif-2015-5, echo=FALSE, warning=FALSE}
flextable(comp.table) %>%
  hline(i = (nrow(comp.table)-1)) %>%
  set_caption(paste0("A comparison of results of data extraction for ", YMD, " using Ver1.0 and Ver2.0. n.XXX is the number of observed whales, vs.XXX is the visibility, and BF.XXX is the Beaufort scale, where XXX is either Ver1.0 or Ver2.0. Beginning time (begin.time) for each shift may be different between Ver1.0 and Ver2.0 because Ver1.0 did not use seconds to determine the beginning and end of each shift, whereas Ver2.0 used the entire information. Each shift may be split in two lines if the start time (begin.time) is not exactly the same.")) %>%
  set_table_properties(width = 0.5, layout = "autofit")

```

The data indicated that first shift was from `r fractional_Day2YMDhms(Data_Out.v2.tmp[1, "begin"], YEAR)$hms` to `r fractional_Day2YMDhms(Data_Out.v2.tmp[1, "end"], YEAR)$hms`, whereas the second shift was from `r fractional_Day2YMDhms(Data_Out.v2.tmp[2, "begin"], YEAR)$hms` to `r fractional_Day2YMDhms(Data_Out.v2.tmp[2, "end"], YEAR)$hms`. The output of Ver1.0, however, indicated that the first shift was from `r fractional_Day2YMDhms(tmp.V0[1, "begin"], YEAR)$hms` to `r fractional_Day2YMDhms(tmp.V0[1, "end"], YEAR)$hms`. In the raw data file, there is no data between 7:31:23 and 10:00:26 (Table \@ref(tab:Table-data-2015-5)). I think it's best to start from the second shift that started at 10 a.m.   

```{r Table-data-2015-5, echo=FALSE, warning=FALSE}
flextable(first.rows) %>%
  set_caption(paste0("The first eight rows of the raw data for ", 
                     fractional_Day2YMDhms(out.list$difs.1[idx, "begin"],
                                           YEAR)$YMD, ", where V1 = event ID, V2 = event code (S = sighting, E = end of shift), V3 = date, V4 = time, V5 = gropu ID, V6 = compass bearing, V7 = reticles, V8 = distance in nm, V9 = group size, V10 = primary observer, V11 = secondary observer, V12 = Beaufort scale, V13  = visibility code, V14 = direction of movement when V2 = 'S', V5 = Beaufort scale and V6 = visibility code when V2 = 'V', V5 and V6 show observers when V2 = 'P'. Event code (V2) = 'B' and 'E' indicate the beginning and end of an observation period, respectively."))  %>%
  set_table_properties(width = 0.5, layout = "autofit")
```


#### (6) `r fractional_Day2YMDhms(out.list$difs.1[6,"begin"], YEAR)$YMD` {-}

```{r dif-2015-6, warning=FALSE, include=FALSE, error=FALSE}
idx <- 6
out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V0") -> tmp.V0

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V2") -> tmp.V2

comp.table <- n.comparison(out.list$FinalData.Both, out.list$difs.1, idx, YEAR)

out.list$Data_Out.v2 %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"])  -> Data_Out.v2.tmp

FF <- Data_Out.v2.tmp[1, "ff"]
data <- get.data("Data/", YEAR, ff = FF)

shift <- 2
out.shift <- get.shift(YEAR, data, ff=FF, i=shift)

out.shift$data %>% select(V5, V9) %>%
  mutate(V5 = as.numeric(V5), V9 = as.numeric(V9)) %>%
  group_by(V5) %>%
  summarize(n = last(V9)) -> summary.data.V2

data %>% 
  filter(begin >= Data_Out.v2.tmp[shift,"begin"] & 
           begin <= Data_Out.v2.tmp[shift, "end"]) %>%
  filter(V2 == "S") %>%
  select(V5, V9) %>%
  mutate(V5 = as.numeric(V5), V9 = as.numeric(V9)) %>%
  group_by(V5) %>%
  summarize(n = last(V9)) -> summary.data

```


The last inconsistency for 2015 was found for `r fractional_Day2YMDhms(out.list$difs.1[idx, "begin"], YEAR)$YMD` (`r FILES[FF]`). There was `r abs(out.list$difs.1[idx, "total.whales"])` more whale in the output from `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver2.0", "Ver1.0")` than that from `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver1.0", "Ver2.0")` (Table \@ref(tab:Table-dif-2015-6)). 


```{r Table-dif-2015-6, echo=FALSE, warning=FALSE}
flextable(comp.table) %>%
  hline(i = (nrow(comp.table)-1)) %>%
  set_caption(paste0("A comparison of results of data extraction for ", YMD, " using Ver1.0 and Ver2.0. n.XXX is the number of observed whales, vs.XXX is the visibility, and BF.XXX is the Beaufort scale, where XXX is either Ver1.0 or Ver2.0. Beginning time (begin.time) for each shift may be different between Ver1.0 and Ver2.0 because Ver1.0 did not use seconds to determine the beginning and end of each shift, whereas Ver2.0 used the entire information. Each shift may be split in two lines if the start time (begin.time) is not exactly the same.")) %>%
  set_table_properties(width = 0.5, layout = "autofit")
```

I don't know why there was one less whale found in the output of Ver2.0 compared with the output of Ver1.0 for the second shift.


### 2016 {-}

```{r compare-2016, echo=FALSE}
# this is for the 6th data set in the analysis (2016)
YEAR <- 2016
FILES <- list.files(paste0("Data/", YEAR, "/"))
idx.yr <- 6

# # periods for the 6 survey years
# periods <-c(136, 135, 164, 178, 179, 151)
# obs.list <- read.csv("Data/Observer list.csv", header = T) 
# colnames(obs.list) <- c("obs", "ID")
# update the observer list from the last one
obs.list <- out.list$obs.list
out.list <- compare.V0.V2.BUGSinput(YEAR, idx.yr, periods, obs.list)

```

There were wrong entries of "South" in "EDITED GW160202_071118.dat" (FF=22). Some lines were fixed to align entries. No VS were entered in rows from 005 to 024. NA entered. 

#### (1) `r fractional_Day2YMDhms(out.list$difs.1[1,"begin"], YEAR)$YMD`  {-}

```{r dif-2016-01, warning=FALSE, include=FALSE, error=FALSE}
idx <- 1
YMD <- fractional_Day2YMDhms(out.list$difs.1[idx,"begin"], YEAR)$YMD

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V0") -> tmp.V0

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V2") -> tmp.V2

comp.table <- n.comparison(out.list$FinalData.Both, out.list$difs.1, idx, YEAR)

out.list$Data_Out.v2 %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"])  -> Data_Out.v2.tmp

FF <- Data_Out.v2.tmp[1, "ff"]
data <- get.data("Data/", YEAR, ff = FF)

# shift <- 1
#out.shift.1 <- get.shift(YEAR, data, ff=FF, i=1)

first.rows <- head(data, 15) %>% select(-c(V15:begin))
```

The first inconsistency for 2016 was for `r fractional_Day2YMDhms(out.list$difs.1[idx, "begin"], YEAR)$YMD` (`r FILES[FF]`). There were `r abs(out.list$difs.1[idx, "total.whales"])` more whales in the output of `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver2.0", "Ver1.0")` than in that of `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver1.0", "Ver2.0")` (Table \@ref(tab:Table-dif-2016-01)). 


```{r Table-dif-2016-01, echo=FALSE, warning=FALSE}

flextable(comp.table) %>%
  hline(i = (nrow(comp.table)-1)) %>%
  set_caption(paste0("A comparison of results of data extraction for ", YMD, " using Ver1.0 and Ver2.0. n.XXX is the number of observed whales, vs.XXX is the visibility, and BF.XXX is the Beaufort scale, where XXX is either Ver1.0 or Ver2.0. Beginning time (begin.time) for each shift may be different between Ver1.0 and Ver2.0 because Ver1.0 did not use seconds to determine the beginning and end of each shift, whereas Ver2.0 used the entire information. Each shift may be split in two lines if the start time (begin.time) is not exactly the same in Ver1.0 and Ver2.0.")) %>%
  set_table_properties(width = 0.5, layout = "autofit")

```

This difference was found in the first shift, which lasted only 30 minutes (`r fractional_Day2YMDhms(Data_Out.v2.tmp[1, "begin"], YEAR)$hms` - `r fractional_Day2YMDhms(Data_Out.v2.tmp[1, "end"], YEAR)$hms`), where a new observer replaced one observer. Consequently, this shift was excluded by the "correct length" filter, which filtered out shifts that were less than 85 minutes or longer than 95 minutes. In the Ver1.0 output (Table \@ref(tab:Table-data-2016-01)), however, a new starting time (`r fractional_Day2YMDhms(tmp.V0[1, "begin"], YEAR)$hms`) was inserted, which  does not exist in the raw data file (Table \@ref(tab:Table-data-2016-01)). 

```{r Table-data-2016-01, echo=FALSE, warning=FALSE}
flextable(first.rows) %>%
  set_caption(paste0("The first 15 rows of the raw data for ", 
                     fractional_Day2YMDhms(out.list$difs.1[idx, "begin"],
                                           YEAR)$YMD, ", where V1 = event ID, V2 = event code (S = sighting, E = end of shift), V3 = date, V4 = time, V5 = gropu ID, V6 = compass bearing, V7 = reticles, V8 = distance in nm, V9 = group size, V10 = primary observer, V11 = secondary observer, V12 = Beaufort scale, V13  = visibility code, V14 = direction of movement, when V2 = 'S', V5 = Beaufort scale and V6 = visibility code when V2 = 'V', V5 and V6 show observers when V2 = 'P'. Event code (V2) = 'B' and 'E' indicate the beginning and end of an observation period, respectively."))  %>%
  set_table_properties(width = 0.5, layout = "autofit")
```

I think it is inappropriate to create a new start time, where there was no observation between `r fractional_Day2YMDhms(tmp.V0[1, "begin"], YEAR)$hms` and 8:30:33.

#### (2) `r fractional_Day2YMDhms(out.list$difs.1[2,"begin"], YEAR)$YMD` {-}

```{r dif-2016-02, warning=FALSE, include=FALSE, error=FALSE}
idx <- 2
YMD <- fractional_Day2YMDhms(out.list$difs.1[idx,"begin"], YEAR)$YMD

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V0") -> tmp.V0

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V2") -> tmp.V2

comp.table <- n.comparison(out.list$FinalData.Both, out.list$difs.1, idx, YEAR)

out.list$Data_Out.v2 %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"])  -> Data_Out.v2.tmp

FF <- Data_Out.v2.tmp[1, "ff"]
data <- get.data("Data/", YEAR, ff = FF)

shift <- 6
out.shift <- get.shift(YEAR, data, ff=FF, i=shift)

data %>% 
  filter(begin >= tmp.V0[shift,"begin"] & begin <= tmp.V0[shift, "end"]) %>%
  filter(V2 == "S") %>%
  select(V5, V9) %>%
  mutate(V5 = as.numeric(V5), V9 = as.numeric(V9)) %>%
  group_by(V5) %>%
  summarize(n = last(V9)) -> summary.V0

data %>% 
  filter(begin >= tmp.V2[shift,"begin"] & begin <= tmp.V2[shift, "end"]) %>%
  filter(V2 == "S") %>%
  select(V5, V9) %>%
  mutate(V5 = as.numeric(V5), V9 = as.numeric(V9)) %>%
  group_by(V5) %>%
  summarize(n = last(V9)) -> summary.V2

# comparing summary.V0 and summary.V2 shows that the group 69 was excluded from V0 output
# The group was observed/recorded 1 second before the end of the shift. Not using seconds
# in V0 excluded this sighting. 

last.rows <- tail(data) %>% select(-c(V15:begin))

```

The summary results for `r fractional_Day2YMDhms(out.list$difs.1[idx, "begin"], YEAR)$YMD` (`r FILES[FF]`) contained `r abs(out.list$difs.1[idx, "total.whales"])` more whale in the output of `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver2.0", "Ver1.0")` than in that of `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver1.0", "Ver2.0")` (Table \@ref(tab:Table-dif-2016-02)). 


```{r Table-dif-2016-02, echo=FALSE, warning=FALSE}
flextable(comp.table) %>%
    hline(i = (nrow(comp.table)-1)) %>%
  set_caption(paste0("A comparison of results of data extraction for ", YMD, " using Ver1.0 and Ver2.0. n.XXX is the number of observed whales, vs.XXX is the visibility, and Bf.XXX is the Beaufort scale, where XXX is either Ver1.0 or Ver2.0")) %>%
  set_table_properties(width = 0.5, layout = "autofit")

```

In Ver1.0, there was no record of group ID 69, which was observed at `r fractional_Day2YMDhms(out.shift$data[str_detect(out.shift$data$V5, "69"), "begin"], YEAR)$hms`, only one second before the end of the shift (Table \@ref(tab:Table-data-2016-02)). The end of this shift in Ver1.0 was `r fractional_Day2YMDhms(tmp.V0[6,"end"], YEAR)`. Consequently, the last sighting was not included in the summary data. 

```{r Table-data-2016-02, echo=FALSE, warning=FALSE}
flextable(last.rows) %>%
    
    set_caption(paste0("The last six rows of the raw data for ", 
                     fractional_Day2YMDhms(out.list$difs.1[idx, "begin"],
                                           YEAR)$YMD, " between ", 
                     last.rows[1, "V4"], 
                     " and ", last.rows[nrow(last.rows), "V4"], 
                     ", where V1 = event ID, V2 = event code (S = sighting, E = end of shift), V3 = date, V4 = time, V5 = gropu ID, V6 = compass bearing, V7 = reticles, V8 = distance in nm, V9 = group size, V10 = primary observer, V11 = secondary observer, V12 = Beaufort scale, V13  = visibility code, V14 = direction of movement when V2 = 'S', V5 = Beaufort scale and V6 = visibility code when V2 = 'V', V5 and V6 show observers when V2 = 'P'. Event code (V2) = 'B' and 'E' indicate the beginning and end of an observation period, respectively."))  %>%
  set_table_properties(width = 0.5, layout = "autofit")
```



#### (3) `r fractional_Day2YMDhms(out.list$difs.1[3,"begin"], YEAR)$YMD` {-}

```{r dif-2016-03, warning=FALSE, include=FALSE, error=FALSE}
idx <- 3
YMD <- fractional_Day2YMDhms(out.list$difs.1[idx,"begin"], YEAR)$YMD
out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V0") -> tmp.V0

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V2") -> tmp.V2

comp.table <- n.comparison(out.list$FinalData.Both, out.list$difs.1, idx, YEAR)

out.list$Data_Out.v2 %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"])  -> Data_Out.v2.tmp

FF <- Data_Out.v2.tmp[1, "ff"]
data <- get.data("Data/", YEAR, ff = FF)

shift <-  1
out.shift.1 <- get.shift(YEAR, data, ff=FF, i=shift)

first.rows <- head(out.shift.1$data.shift, 8) %>%
  select(-c(V15:begin))
```

The data summary for `r fractional_Day2YMDhms(out.list$difs.1[idx, "begin"], YEAR)$YMD` (`r FILES[FF]`) contained `r abs(out.list$difs.1[idx, "total.whales"])` more whales in the output of `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver2.0", "Ver1.0")` than in that of `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver1.0", "Ver2.0")` (Table \@ref(tab:Table-dif-2016-03)). 


```{r Table-dif-2016-03, echo=FALSE, warning=FALSE}

flextable(comp.table) %>%
   hline(i = (nrow(comp.table)-1)) %>%
  set_caption(paste0("A comparison of results of data extraction for ", YMD, " using Ver1.0 and Ver2.0. n.XXX is the number of observed whales, vs.XXX is the visibility, and BF.XXX is the Beaufort scale, where XXX is either Ver1.0 or Ver2.0")) %>%
  set_table_properties(width = 0.5, layout = "autofit")

```

There were total of `r nrow(Data_Out.v2.tmp)` shifts for this day. The first shift was from `r fractional_Day2YMDhms(Data_Out.v2.tmp[1, "begin"], YEAR)$hms` to `r fractional_Day2YMDhms(Data_Out.v2.tmp[1, "end"], YEAR)$hms` (`r signif(Data_Out.v2.tmp[1, "dur"] * 24 * 60, 3)` minutes). The raw data file (Table \@ref(tab:Table-data-2016-03)) indicated that the first shift started at 8 a.m. In the output of Ver1.0, however, the first shift started at `r fractional_Day2YMDhms(tmp.V0[1,"begin"], YEAR)$hms`.

```{r Table-data-2016-03, echo=FALSE, warning=FALSE}
flextable(first.rows) %>%
  set_caption(paste0("The first eight rows of the raw data for ", 
                     fractional_Day2YMDhms(out.list$difs.1[idx, "begin"],
                                           YEAR)$YMD, "between " ,
                     first.rows[1, "V4"], 
                     " and ", first.rows[nrow(first.rows), "V4"], 
                     ", where V1 = event ID, V2 = event code (S = sighting, E = end of shift), V3 = date, V4 = time, V5 = gropu ID, V6 = compass bearing, V7 = reticles, V8 = distance in nm, V9 = group size, V10 = primary observer, V11 = secondary observer, V12 = Beaufort scale, V13  = visibility code, V14 = direction of movement when V2 = 'S', V5 = Beaufort scale and V6 = visibility code when V2 = 'V', V5 and V6 show observers when V2 = 'P'. Event code (V2) = 'B' and 'E' indicate the beginning and end of an observation period, respectively."))  %>%
  set_table_properties(width = 0.5, layout = "autofit")

```


I don't think it's proper to inflate the hours of observation. 

#### (4) `r fractional_Day2YMDhms(out.list$difs.1[4,"begin"], YEAR)$YMD` {-}

```{r dif-2016-04, warning=FALSE, include=FALSE, error=FALSE}
idx <- 4
YMD <- fractional_Day2YMDhms(out.list$difs.1[idx,"begin"], YEAR)$YMD

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V0") -> tmp.V0

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V2") -> tmp.V2

comp.table <- n.comparison(out.list$FinalData.Both, out.list$difs.1, idx, YEAR)

# V2 is missing the first and second shifts
out.list$Data_Out.v2 %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) -> Data_Out.v2.tmp

# The first and second shifts are too short... 
FF <- Data_Out.v2.tmp[1, "ff"]

data <- get.data("Data/", YEAR, ff = FF)

shift <-  1
out.shift.1 <- get.shift(YEAR, data, ff=FF, i=shift)
# The first shift started at 8:30:06, ended at 8:56:51, so < 1 hr

shift <-  2
out.shift.2 <- get.shift(YEAR, data, ff=FF, i=shift)
# Started at 10:34:53 and ended 10:56:57, so < 1 hr
first.rows <- head(data) %>%
  select(-c(V15:begin))
```

The data summary for `r fractional_Day2YMDhms(out.list$difs.1[idx, "begin"], YEAR)$YMD` (`r FILES[FF]`) contained `r abs(out.list$difs.1[idx, "total.whales"])` more whales and 2 more shifts in the output of `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver2.0", "Ver1.0")` than in that of `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver1.0", "Ver2.0")` (Table \@ref(tab:Table-dif-2016-04)). 


```{r Table-dif-2016-04, echo=FALSE, warning=FALSE}
flextable(comp.table) %>%
  hline(i = (nrow(comp.table)-1)) %>%
  set_caption(paste0("A comparison of results of data extraction for ", YMD, " using Ver1.0 and Ver2.0. n.XXX is the number of observed whales, vs.XXX is the visibility, and BF.XXX is the Beaufort scale, where XXX is either Ver1.0 or Ver2.0")) %>%
  set_table_properties(width = 0.5, layout = "autofit")

```

The first two shifts from Ver1.0 were not found in the output of Ver2.0. According to the output of Ver2.0, the first shift started at `r fractional_Day2YMDhms(Data_Out.v2.tmp[1, "begin"], YEAR)$hms` and ended at `r fractional_Day2YMDhms(Data_Out.v2.tmp[1, "end"], YEAR)$hms` (`r Data_Out.v2.tmp[1, "dur"] * 24 * 60` minutes).  The raw data file also indicated that it started at this time. (Table \@ref(tab:Table-data-2016-04)). Based on the length of this shift, it should have been excluded in the data extraction process. In the output of Ver1.0, however, the first shift started at `r fractional_Day2YMDhms(tmp.V0[1, "begin"], YEAR)$hms` and ended at `r fractional_Day2YMDhms(tmp.V0[1, "end"], YEAR)$hms`. This is not right because there was no observation between 7:30 and 8:30. 

```{r Table-data-2016-04, echo=FALSE, warning=FALSE}
flextable(first.rows) %>%
  set_caption(paste0("The first eight rows of the raw data for ", 
                     fractional_Day2YMDhms(out.list$difs.1[idx, "begin"],
                                           YEAR)$YMD, " between ",
                     first.rows[1, "V4"], 
                     " and ", first.rows[nrow(first.rows), "V4"], 
                     ",where V1 = event ID, V2 = event code (S = sighting, E = end of shift), V3 = date, V4 = time, V5 = gropu ID, V6 = compass bearing, V7 = reticles, V8 = distance in nm, V9 = group size, V10 = primary observer, V11 = secondary observer, V12 = Beaufort scale, V13  = visibility code, V14 = direction of movement when V2 = 'S', V5 = Beaufort scale and V6 = visibility code when V2 = 'V', V5 and V6 show observers when V2 = 'P'. Event code (V2) = 'B' and 'E' indicate the beginning and end of an observation period, respectively."))  %>%
  set_table_properties(width = 0.5, layout = "autofit")
```


For the second shift, data indicated that it started at `r fractional_Day2YMDhms(Data_Out.v2.tmp[2, "begin"], YEAR)$hms` and ended at `r fractional_Day2YMDhms(Data_Out.v2.tmp[2, "end"], YEAR)$hms` (`r signif(Data_Out.v2.tmp[2, "dur"] * 24 * 60, 3)` minutes, Table \@ref(tab:Table-data-2016-04a)). In the output of Ver1.0, however, it started at `r fractional_Day2YMDhms(tmp.V0[2, "begin"], YEAR)$hms` and ended at `r fractional_Day2YMDhms(tmp.V0[2, "end"], YEAR)$hms`. This is also not good because there was no observation between 10:56:57 and 12:00:00 (> 1hr). I think these two shifts should be removed. 

```{r Table-data-2016-04a, echo=FALSE, warning=FALSE}
data.2 <- rbind(out.shift.2$data.shift, head(out.shift.2$data.next.shift)) %>%
  select(-c(V15:begin))

flextable(data.2) %>%
  set_caption(paste0("Raw data for ", 
                     fractional_Day2YMDhms(out.list$difs.1[idx, "begin"],
                                           YEAR)$YMD, "between  ",
                     data.2[1, "V4"], 
                     " and ", data.2[nrow(data.2), "V4"], 
                     ", where V1 = event ID, V2 = event code (S = sighting, E = end of shift), V3 = date, V4 = time, V5 = gropu ID, V6 = compass bearing, V7 = reticles, V8 = distance in nm, V9 = group size, V10 = primary observer, V11 = secondary observer, V12 = Beaufort scale, V13  = visibility code, V14 = direction of movement when V2 = 'S', V5 = Beaufort scale and V6 = visibility code when V2 = 'V', V5 and V6 show observers when V2 = 'P'. Event code (V2) = 'B' and 'E' indicate the beginning and end of an observation period, respectively."))  %>%
  set_table_properties(width = 0.5, layout = "autofit")
```


#### (5) `r fractional_Day2YMDhms(out.list$difs.1[5,"begin"], YEAR)$YMD` {-}

```{r dif-2016-05, warning=FALSE, include=FALSE, error=FALSE}
idx <- 5
YMD <- fractional_Day2YMDhms(out.list$difs.1[idx,"begin"], YEAR)$YMD

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V0") -> tmp.V0

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V2") -> tmp.V2

# V0 is missing the third shift (n = 13) and one less whale in the last (6th) shift

comp.table <- n.comparison(out.list$FinalData.Both, out.list$difs.1, idx, YEAR)

out.list$Data_Out.v2 %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) -> Data_Out.v2.tmp

FF <- Data_Out.v2.tmp[1, "ff"]
data <- get.data("Data/", YEAR, ff = FF)

out.shift.3 <- get.shift(YEAR, data, ff=FF, i=3)
# I don't know why this shift was thrown out in V0... 

out.shift.6 <- get.shift(YEAR, data, ff=FF, i=6)

last.rows <- tail(out.shift.6$data.shift) %>% select(-c(V15:begin))
```


The data summary for `r fractional_Day2YMDhms(out.list$difs.1[idx, "begin"], YEAR)$YMD` (`r FILES[FF]`) contained `r abs(out.list$difs.1[idx, "total.whales"])` more whales and `r abs(nrow(tmp.V0) - nrow(tmp.V2))` more shifts in `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver2.0", "Ver1.0")` than in `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver1.0", "Ver2.0")` (Table \@ref(tab:Table-dif-2016-05)).  

The third shift was missing from the output of Ver1.0. The shift lasted from `r fractional_Day2YMDhms(Data_Out.v2.tmp[3, "begin"], YEAR)$hms` to `r fractional_Day2YMDhms(Data_Out.v2.tmp[3, "end"], YEAR)$hms` of `r signif(Data_Out.v2.tmp[3, "dur"] * 24 * 60, 3)` minutes. The maximum Beaufort was `r Data_Out.v2.tmp[3, "bf"]` and visibility of `r Data_Out.v2.tmp[3, "vs"]`. I'm not sure why this shift was excluded in Ver1.0.


```{r Table-dif-2016-05, echo=FALSE, warning=FALSE}
flextable(comp.table) %>%
  hline(i = (nrow(comp.table)-1)) %>%
  set_caption(paste0("A comparison of results of data extraction for ", YMD, " using Ver1.0 and Ver2.0. n.XXX is the number of observed whales, vs.XXX is the visibility, and BF.XXX is the Beaufort scale, where XXX is either Ver1.0 or Ver2.0")) %>%
  set_table_properties(width = 0.5, layout = "autofit")
```

For the last shift, the last sighting was at `r out.shift.6$data[nrow(out.shift.6$data),"V4"]`, which was after the end-of-shift time in the output of Ver1.0 (`r fractional_Day2YMDhms(tmp.V0[5,"end"], YEAR)$hms`). Consequently, this sighting was excluded in the output of Ver1.0. This explains the difference in the last shift (Table \@ref(tab:Table-data-2016-05)). 


```{r Table-data-2016-05, echo=FALSE, warning=FALSE}
flextable(last.rows) %>% 
  set_caption(paste0("Raw data for ", 
                     fractional_Day2YMDhms(out.list$difs.1[idx, "begin"],
                                           YEAR)$YMD, "between  ",
                     last.rows[1, "V4"], 
                     " and ", last.rows[nrow(last.rows), "V4"], 
                     ", where V1 = event ID, V2 = event code (S = sighting, E = end of shift), V3 = date, V4 = time, V5 = gropu ID, V6 = compass bearing, V7 = reticles, V8 = distance in nm, V9 = group size, V10 = primary observer, V11 = secondary observer, V12 = Beaufort scale, V13  = visibility code, V14 = direction of movement when V2 = 'S', V5 = Beaufort scale and V6 = visibility code when V2 = 'V', V5 and V6 show observers when V2 = 'P'. Event code (V2) = 'B' and 'E' indicate the beginning and end of an observation period, respectively."))  %>%
  set_table_properties(width = 0.5, layout = "autofit")
```


#### (6) `r fractional_Day2YMDhms(out.list$difs.1[6,"begin"], YEAR)$YMD` {-}

```{r dif-2016-06, warning=FALSE, include=FALSE, error=FALSE}
idx <- 6
YMD <- fractional_Day2YMDhms(out.list$difs.1[idx,"begin"], YEAR)$YMD

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V0") -> tmp.V0

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V2") -> tmp.V2

comp.table <- n.comparison(out.list$FinalData.Both, out.list$difs.1, idx, YEAR)

out.list$Data_Out.v2 %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) -> Data_Out.v2.tmp

FF <- Data_Out.v2.tmp[1, "ff"]
data <- get.data("Data/", YEAR, ff = FF)

out.shift.6 <- get.shift(YEAR, data, ff=FF, i=6)
last.rows <- tail(out.shift.6$data.shift) %>% select(-c(V15:begin))

```


The data summary for `r fractional_Day2YMDhms(out.list$difs.1[idx, "begin"], YEAR)$YMD` (`r FILES[FF]`) contained `r abs(out.list$difs.1[idx, "total.whales"])` more whale in the output of `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver2.0", "Ver1.0")` than in that of `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver1.0", "Ver2.0")` (Table \@ref(tab:Table-dif-2016-06)). 


```{r Table-dif-2016-06, echo=FALSE, warning=FALSE}
flextable(comp.table) %>%
  hline(i = (nrow(comp.table)-1)) %>%
set_caption(paste0("A comparison of results of data extraction for ", YMD, " using Ver1.0 and Ver2.0. n.XXX is the number of observed whales, vs.XXX is the visibility, and BF.XXX is the Beaufort scale, where XXX is either Ver1.0 or Ver2.0")) %>%
  set_table_properties(width = 0.5, layout = "autofit")
```

The last sighting was at `r out.shift.6$data[nrow(out.shift.6$data),"V4"]`, which was after the end-of-shift time in the output of Ver1.0 (`r fractional_Day2YMDhms(tmp.V0[6,"end"], YEAR)$hms`). Consequently, this sighting was excluded in the output of Ver1.0. This explains the difference in the last shift (Table \@ref(tab:Table-data-2016-06)). 


```{r Table-data-2016-06, echo=FALSE, warning=FALSE}
flextable(last.rows) %>% 
  set_caption(paste0("Raw data for ", 
                     fractional_Day2YMDhms(out.list$difs.1[idx, "begin"],
                                           YEAR)$YMD, "between  ",
                     last.rows[1, "V4"], 
                     " and ", last.rows[nrow(last.rows), "V4"], 
                     ", where V1 = event ID, V2 = event code (S = sighting, E = end of shift), V3 = date, V4 = time, V5 = gropu ID, V6 = compass bearing, V7 = reticles, V8 = distance in nm, V9 = group size, V10 = primary observer, V11 = secondary observer, V12 = Beaufort scale, V13  = visibility code, V14 = direction of movement when V2 = 'S', V5 = Beaufort scale and V6 = visibility code when V2 = 'V', V5 and V6 show observers when V2 = 'P'. Event code (V2) = 'B' and 'E' indicate the beginning and end of an observation period, respectively."))  %>%
  set_table_properties(width = 0.5, layout = "autofit")
```


#### (7) `r fractional_Day2YMDhms(out.list$difs.1[7,"begin"], YEAR)$YMD` {-}

```{r dif-2016-07, warning=FALSE, include=FALSE, error=FALSE}
idx <- 7
YMD <- fractional_Day2YMDhms(out.list$difs.1[idx,"begin"], YEAR)$YMD
out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V0") -> tmp.V0

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V2") -> tmp.V2

comp.table <- n.comparison(out.list$FinalData.Both, out.list$difs.1, idx, YEAR)

out.list$Data_Out.v2 %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) -> Data_Out.v2.tmp

FF <- Data_Out.v2.tmp[1, "ff"]
data <- get.data("Data/", YEAR, ff = FF)

out.shift.6 <- get.shift(YEAR, data, ff=FF, i=6)
last.rows <- tail(out.shift.6$data.shift) %>% select(-c(V15:begin))

```

The data summary for `r fractional_Day2YMDhms(out.list$difs.1[idx, "begin"], YEAR)$YMD` (`r FILES[FF]`) contained `r abs(out.list$difs.1[idx, "total.whales"])` more whales in the output of `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver2.0", "Ver1.0")` than in `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver1.0", "Ver2.0")`(Table \@ref(tab:Table-dif-2016-07)).  


```{r Table-dif-2016-07, echo=FALSE, warning=FALSE}

flextable(comp.table) %>%
  hline(i = (nrow(comp.table)-1)) %>%
set_caption(paste0("A comparison of results of data extraction for ", YMD, " using Ver1.0 and Ver2.0. n.XXX is the number of observed whales, vs.XXX is the visibility, and BF.XXX is the Beaufort scale, where XXX is either Ver1.0 or Ver2.0")) %>%
  set_table_properties(width = 0.5, layout = "autofit")

```



The last sighting was at `r out.shift.6$data[nrow(out.shift.6$data),"V4"]`, which was after the end-of-shift time in the output of Ver1.0 (`r fractional_Day2YMDhms(tmp.V0[6,"end"], YEAR)$hms`). Consequently, this sighting was excluded in the output of Ver1.0. This explains the difference in the last shift (Table \@ref(tab:Table-data-2016-07)). 


```{r Table-data-2016-07, echo=FALSE, warning=FALSE}
flextable(last.rows) %>% 
  set_caption(paste0("Raw data for ", 
                     fractional_Day2YMDhms(out.list$difs.1[idx, "begin"],
                                           YEAR)$YMD, "between  ",
                     last.rows[1, "V4"], 
                     " and ", last.rows[nrow(last.rows), "V4"], 
                     ", where V1 = event ID, V2 = event code (S = sighting, E = end of shift), V3 = date, V4 = time, V5 = gropu ID, V6 = compass bearing, V7 = reticles, V8 = distance in nm, V9 = group size, V10 = primary observer, V11 = secondary observer, V12 = Beaufort scale, V13  = visibility code, V14 = direction of movement when V2 = 'S', V5 = Beaufort scale and V6 = visibility code when V2 = 'V', V5 and V6 show observers when V2 = 'P'. Event code (V2) = 'B' and 'E' indicate the beginning and end of an observation period, respectively."))  %>%
  set_table_properties(width = 0.5, layout = "autofit")
```


#### (8) `r fractional_Day2YMDhms(out.list$difs.1[8,"begin"], YEAR)$YMD` {-}

```{r dif-2016-08, warning=FALSE, include=FALSE, error=FALSE}
idx <- 8
YMD <- fractional_Day2YMDhms(out.list$difs.1[idx,"begin"], YEAR)$YMD
out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V0") -> tmp.V0

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V2") -> tmp.V2

comp.table <- n.comparison(out.list$FinalData.Both, out.list$difs.1, idx, YEAR)

out.list$Data_Out.v2 %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) -> Data_Out.v2.tmp

FF <- Data_Out.v2.tmp[1, "ff"]

data <- get.data("Data/", YEAR, ff = FF)

shift <-  1
out.shift.1 <- get.shift(YEAR, data, ff=FF, i=shift)

shift <-  2
out.shift.2 <- get.shift(YEAR, data, ff=FF, i=shift)

# Raw data file has the starting time of 13:40:05, which was changed to
# 13:30:00 to include this shift in the analysis. 

first.rows <- head(out.shift.1$data.shift) %>%
  select(-c(V15:begin))

# Changing the "grace period" to 10 minutes would include this shift without
# modifying the data.

```

The data summary for `r fractional_Day2YMDhms(out.list$difs.1[idx, "begin"], YEAR)$YMD` (`r FILES[FF]`) contained `r abs(out.list$difs.1[idx, "total.whales"])` more whales in the output of `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver2.0", "Ver1.0")` than in that of `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver1.0", "Ver2.0")` (Table \@ref(tab:Table-dif-2016-08)). 


```{r Table-dif-2016-08, echo=FALSE, warning=FALSE}

flextable(comp.table) %>%
  hline(i = (nrow(comp.table)-1)) %>%
set_caption(paste0("A comparison of results of data extraction for ", YMD, " using Ver1.0 and Ver2.0. n.XXX is the number of observed whales, vs.XXX is the visibility, and BF.XXX is the Beaufort scale, where XXX is either Ver1.0 or Ver2.0")) %>%
  set_table_properties(width = 0.5, layout = "autofit")

```

There were a total of `r nrow(Data_Out.v2.tmp)` shifts on `r fractional_Day2YMDhms(out.list$difs.1[idx, "begin"], YEAR)$YMD`. The first shift started at `r fractional_Day2YMDhms(Data_Out.v2.tmp[1, "begin"], YEAR)$hms` and ended at `r fractional_Day2YMDhms(Data_Out.v2.tmp[1, "end"], YEAR)$hms` (`r signif(Data_Out.v2.tmp[1, "dur"], 2) * 24 * 60` minutes). The raw data also indicated that the shift started at `r first.rows[1, "V4"]` (Table \@ref(tab:Table-data-2016-08)). Consequently, this shift should have been removed because it was too short. Alternatively, the start time should be changed in the data file. 


```{r Table-data-2016-08, echo=FALSE, warning=FALSE}
flextable(first.rows) %>% 
  set_caption(paste0("Raw data for ", 
                     fractional_Day2YMDhms(out.list$difs.1[idx, "begin"],
                                           YEAR)$YMD, " between ",
                     first.rows[1, "V4"], 
                     " and ", first.rows[nrow(first.rows), "V4"], 
                     ", where V1 = event ID, V2 = event code (S = sighting, E = end of shift), V3 = date, V4 = time, V5 = gropu ID, V6 = compass bearing, V7 = reticles, V8 = distance in nm, V9 = group size, V10 = primary observer, V11 = secondary observer, V12 = Beaufort scale, V13  = visibility code, V14 = direction of movement when V2 = 'S', V5 = Beaufort scale and V6 = visibility code when V2 = 'V', V5 and V6 show observers when V2 = 'P'. Event code (V2) = 'B' and 'E' indicate the beginning and end of an observation period, respectively."))  %>%
  set_table_properties(width = 0.5, layout = "autofit")
```

For the second shift, VS changed to 5 at 15:15:24 but backed down to 4 at 15:22:58. The current filtering algorithm uses the maximum value, so this shift should have been removed. But, in general, this shift may be okay to be included because VS = 5 for only 7 minutes. During this 7 minutes, only one group (ID = 20) was sighted 3 times. The group was sighted again after VS reduced to 4. So, I deleted those three sightings in the raw data file (with _TE addition to the data file name).

#### (9) `r fractional_Day2YMDhms(out.list$difs.1[9,"begin"], YEAR)$YMD` {-}

```{r dif-2016-09, warning=FALSE, include=FALSE, error=FALSE}
idx <- 9
YMD <- fractional_Day2YMDhms(out.list$difs.1[idx,"begin"], YEAR)$YMD
out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V0") -> tmp.V0

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V2") -> tmp.V2

comp.table <- n.comparison(out.list$FinalData.Both, out.list$difs.1, idx, YEAR)
out.list$Data_Out.v2 %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) -> Data_Out.v2.tmp

FF <- Data_Out.v2.tmp[1, "ff"]

data <- get.data("Data/", YEAR, ff = FF)

shift <-  1
out.shift.1 <- get.shift(YEAR, data, ff=FF, i=shift)

first.rows <- head(out.shift.1$data.shift) %>% select(-c(V15:begin))

# The begin time for the first shift was modified. 
# Data file indicates the start time was 7:43:13 but in the data, it was changed
# to 7:30:00

```

The data summary for `r fractional_Day2YMDhms(out.list$difs.1[idx, "begin"], YEAR)$YMD` (`r FILES[FF]`) contained `r abs(out.list$difs.1[idx, "total.whales"])` more whales and `r abs(nrow(tmp.V0) - nrow(tmp.V2))` more shift in the output of `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver2.0", "Ver1.0")` than in that of `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver1.0", "Ver2.0")` (Table \@ref(tab:Table-dif-2016-09)).


```{r Table-dif-2016-09, echo=FALSE, warning=FALSE}

flextable(comp.table) %>%
  hline(i = (nrow(comp.table)-1)) %>%
set_caption(paste0("A comparison of results of data extraction for ", YMD, " using Ver1.0 and Ver2.0. n.XXX is the number of observed whales, vs.XXX is the visibility, and BF.XXX is the Beaufort scale, where XXX is either Ver1.0 or Ver2.0")) %>%
  set_table_properties(width = 0.5, layout = "autofit")

```

The first shift was missing from the output of Ver2.0. The shift started at `r fractional_Day2YMDhms(Data_Out.v2.tmp[1, "begin"], YEAR)$hms` and ended at `r fractional_Day2YMDhms(Data_Out.v2.tmp[1, "end"], YEAR)$hms` (`r signif(Data_Out.v2.tmp[1, "dur"] * 24 * 60, 3)` minutes). The start time in the output of Ver1.0, however, was `r fractional_Day2YMDhms(tmp.V0[1,"begin"], YEAR)$hms`. The raw data file indicated the beginning of the shift was 7:43:13 (Table \@ref(tab:Table-data-2016-09)). If we follow the inclusion rule for durations of shifts, this shift should be excluded. 


```{r Table-data-2016-09, echo=FALSE, warning=FALSE}
flextable(first.rows) %>% 
  set_caption(paste0("Raw data for ", 
                     fractional_Day2YMDhms(out.list$difs.1[idx, "begin"],
                                           YEAR)$YMD, "between  ",
                     first.rows[1, "V4"], 
                     " and ", first.rows[nrow(first.rows), "V4"], 
                     ", where V1 = event ID, V2 = event code (S = sighting, E = end of shift), V3 = date, V4 = time, V5 = gropu ID, V6 = compass bearing, V7 = reticles, V8 = distance in nm, V9 = group size, V10 = primary observer, V11 = secondary observer, V12 = Beaufort scale, V13  = visibility code, V14 = direction of movement when V2 = 'S', V5 = Beaufort scale and V6 = visibility code when V2 = 'V', V5 and V6 show observers when V2 = 'P'. Event code (V2) = 'B' and 'E' indicate the beginning and end of an observation period, respectively."))  %>%
  set_table_properties(width = 0.5, layout = "autofit")
```


#### (10) `r fractional_Day2YMDhms(out.list$difs.1[10,"begin"], YEAR)$YMD` {-}

```{r dif-2016-10, warning=FALSE, include=FALSE, error=FALSE}
idx <- 10
YMD <- fractional_Day2YMDhms(out.list$difs.1[idx,"begin"], YEAR)$YMD
out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V0") -> tmp.V0

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V2") -> tmp.V2

comp.table <- n.comparison(out.list$FinalData.Both, out.list$difs.1, idx, YEAR)

out.list$Data_Out.v2 %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) -> Data_Out.v2.tmp

FF <- Data_Out.v2.tmp[1, "ff"]

data <- get.data("Data/", YEAR, ff = FF)

shift <-  6
out.shift.6 <- get.shift(YEAR, data, ff=FF, i=shift)

data %>% 
  filter(begin >= tmp.V0[shift,"begin"] & begin <= tmp.V0[shift, "end"]) %>%
  filter(V2 == "S") %>%
  select(V5, V9) %>%
  mutate(V5 = as.numeric(V5), V9 = as.numeric(V9)) %>%
  group_by(V5) %>%
  summarize(n = last(V9)) -> summary.V0

data %>% 
  filter(begin >= tmp.V2[shift,"begin"] & begin <= tmp.V2[shift, "end"]) %>%
  filter(V2 == "S") %>%
  select(V5, V9) %>%
  mutate(V5 = as.numeric(V5), V9 = as.numeric(V9)) %>%
  group_by(V5) %>%
  summarize(n = last(V9)) -> summary.V2

# The last group (59) was missed in V0 probably because of not using seconds
# as the sighting happened 9 seconds before the end of the shift. 

last.rows <- tail(out.shift.6$data.shift) %>% select(-c(V15:begin))

```

The data summary for `r fractional_Day2YMDhms(out.list$difs.1[idx, "begin"], YEAR)$YMD` (`r FILES[FF]`) contained `r abs(out.list$difs.1[idx, "total.whales"])` more whale in the output of `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver2.0", "Ver1.0")` than in that of `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver1.0", "Ver2.0")` (Table \@ref(tab:Table-dif-2016-10)). 


```{r Table-dif-2016-10, echo=FALSE, warning=FALSE}
flextable(comp.table) %>%
  hline(i = (nrow(comp.table)-1)) %>%
set_caption(paste0("A comparison of results of data extraction for ", YMD, " using Ver1.0 and Ver2.0. n.XXX is the number of observed whales, vs.XXX is the visibility, and BF.XXX is the Beaufort scale, where XXX is either Ver1.0 or Ver2.0")) %>%
  set_table_properties(width = 0.5, layout = "autofit")

```

During the last shift (6), Ver1.0 returned `r nrow(summary.V0)` groups, whereas Ver2.0 returned `r nrow(summary.V2)` groups. The last group (ID = `r summary.V2[nrow(summary.V2), "V5"]`) was observed at `r out.shift.6$data[str_detect(out.shift.6$data$V5, summary.V2[nrow(summary.V2), "V5"]%>%pull() %>% as.character()), "V4"]`, which was 9 seconds before the end of the shift (`r out.shift.6$data.shift[nrow(out.shift.6$data.shift), "V4"]`; Table \@ref(tab:Table-data-2016-10)). The end time of this shift according to Ver1.0 was `r fractional_Day2YMDhms(tmp.V0[6,"end"], YEAR)$hms`, which was before the last sighting. 


```{r Table-data-2016-10, echo=FALSE, warning=FALSE}
flextable(last.rows) %>% 
  set_caption(paste0("Raw data for ", 
                     fractional_Day2YMDhms(out.list$difs.1[idx, "begin"],
                                           YEAR)$YMD, "between  ",
                     last.rows[1, "V4"], 
                     " and ", last.rows[nrow(last.rows), "V4"], 
                     ", where V1 = event ID, V2 = event code (S = sighting, E = end of shift), V3 = date, V4 = time, V5 = gropu ID, V6 = compass bearing, V7 = reticles, V8 = distance in nm, V9 = group size, V10 = primary observer, V11 = secondary observer, V12 = Beaufort scale, V13  = visibility code, V14 = direction of movement when V2 = 'S', V5 = Beaufort scale and V6 = visibility code when V2 = 'V', V5 and V6 show observers when V2 = 'P'. Event code (V2) = 'B' and 'E' indicate the beginning and end of an observation period, respectively."))  %>%
  set_table_properties(width = 0.5, layout = "autofit")
```


#### (11) `r fractional_Day2YMDhms(out.list$difs.1[11,"begin"], YEAR)$YMD` {-}

```{r dif-2016-11, warning=FALSE, include=FALSE, error=FALSE}
idx <- 11
YMD <- fractional_Day2YMDhms(out.list$difs.1[idx,"begin"], YEAR)$YMD

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V0") -> tmp.V0

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V2") -> tmp.V2

comp.table <- n.comparison(out.list$FinalData.Both, out.list$difs.1, idx, YEAR)

out.list$Data_Out.v2 %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) -> Data_Out.v2.tmp

FF <- Data_Out.v2.tmp[1, "ff"]

data <- get.data("Data/", YEAR, ff = FF)

out.shift.4 <- get.shift(YEAR, data, ff=FF, i=4)

out.shift.5 <- get.shift(YEAR, data, ff=FF, i=5)

```

The data summary for `r fractional_Day2YMDhms(out.list$difs.1[idx, "begin"], YEAR)$YMD` (`r FILES[FF]`) contained `r abs(out.list$difs.1[idx, "total.whales"])` more whales and `r abs(nrow(tmp.V0) - nrow(tmp.V2))` more shifts in `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver2.0", "Ver1.0")` than in `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver1.0", "Ver2.0")` (Table \@ref(tab:Table-dif-2016-11))).


```{r Table-dif-2016-11, echo=FALSE, warning=FALSE}

flextable(comp.table) %>%
  hline(i = (nrow(comp.table)-1)) %>%
set_caption(paste0("A comparison of results of data extraction for ", YMD, " using Ver1.0 and Ver2.0. n.XXX is the number of observed whales, vs.XXX is the visibility, and BF.XXX is the Beaufort scale, where XXX is either Ver1.0 or Ver2.0")) %>%
  set_table_properties(width = 0.5, layout = "autofit")

```


In Ver1.0, it appears that shifts 4 and 5 were combined, where the duration of these shifts were `r signif(out.shift.4$out.df$dur * 24 * 60, 3)` and `r signif(out.shift.5$out.df$dur * 24 * 60, 3)` minutes, respectively. They don't quite add up to a sufficient duration of at least 85 minutes. The end time was changed from `r fractional_Day2YMDhms(out.shift.5$out.df$begin, YEAR)$hms` to `r fractional_Day2YMDhms(tmp.V0[4, "end"], YEAR)$hms`. 



### 2020 {-}

```{r compare-2020, warning=FALSE, include=FALSE, error=FALSE}

YEAR <- 2020
FILES <- list.files(paste0("Data/", YEAR, "/"))

# obs.list <- read.csv("Data/Observer list.csv", header = T) 
# colnames(obs.list) <- c("obs", "ID")

# update the observer list
obs.list <- out.list$obs.list
if (is.character(obs.list$ID)){
  obs.list$ID <- as.integer(obs.list$ID)
}
out.list <- compare.V0.V2.raw(YEAR, obs.list)

```

#### (1) `r fractional_Day2YMDhms(out.list$difs.1[1,"begin"], YEAR)$YMD` {-}

```{r dif-2020-1, warning=FALSE, include=FALSE, error=FALSE}
idx <- 1
YMD <- fractional_Day2YMDhms(out.list$difs.1[idx,"begin"], YEAR)$YMD
out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V0") -> tmp.V0

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V2") -> tmp.V2

# Nothing returned from V0
comp.table <- n.comparison(out.list$FinalData.Both, out.list$difs.1, idx, YEAR)

out.list$Data_Out.v2 %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) -> Data_Out.v2.tmp

FF <- Data_Out.v2.tmp[1, "ff"]
data <- get.data("Data/", YEAR, ff = FF)

out.list$v0.out$Data_Out %>% filter(ff == FF) -> V0.FF

data %>%
  filter(begin >= V0.FF[4,"begin"] & begin <= V0.FF[4, "end"]) -> V0.FF.4

shift <- 1
out.shift.1 <- get.shift(YEAR, data, ff = FF, i = shift)

shift <- 2
out.shift.2 <- get.shift(YEAR, data, ff = FF, i = shift)

# I believe it has to do with extensive comments... 

```

The data summary for `r fractional_Day2YMDhms(out.list$difs.1[idx, "begin"], YEAR)$YMD` (`r FILES[FF]`) contained `r abs(out.list$difs.1[idx, "total.whales"])` more whales and `r abs(nrow(tmp.V0) - nrow(tmp.V2))` more shifts in the output of  `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver2.0", "Ver1.0")` than in that of `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver1.0", "Ver2.0")` (Table \@ref(tab:Table-dif-2020-1)).


```{r Table-dif-2020-1, echo=FALSE, warning=FALSE}

flextable(comp.table) %>%
  hline(i = (nrow(comp.table)-1)) %>%
set_caption(paste0("A comparison of results of data extraction for ", YMD, " using Ver1.0 and Ver2.0. n.XXX is the number of observed whales, vs.XXX is the visibility, and BF.XXX is the Beaufort scale, where XXX is either Ver1.0 or Ver2.0")) %>%
  set_table_properties(width = 0.5, layout = "autofit")

```

Somehow, all visibility code in the summary data from Ver1.0 were nonsensical, which resulted in all `r nrow(V0.FF)` shifts to be excluded. In the output of Ver2.0, there were `r nrow(Data_Out.v2.tmp)` shifts. Comparing the outputs, the fourth shift in Ver1.0 output was missing in Ver2.0 output, which started at `r fractional_Day2YMDhms(V0.FF[4, "begin"], YEAR)$hms` and ended at `r fractional_Day2YMDhms(V0.FF[4, "end"], YEAR)$hms`. There was no shift between these times.

The first two shifts should be included in the analysis, whereas the last 3 shifts were too short (`r signif(Data_Out.v2.tmp[3, "dur"] * 24 * 60, 3)`, `r signif(Data_Out.v2.tmp[4, "dur"] * 24 * 60, 3)`, and `r signif(Data_Out.v2.tmp[5, "dur"] * 24 * 60, 3)` minutes, respectively). 



#### (2) `r fractional_Day2YMDhms(out.list$difs.1[2,"begin"], YEAR)$YMD` {-}
```{r dif-2020-2, warning=FALSE, include=FALSE, error=FALSE}
idx <- 2
YMD <- fractional_Day2YMDhms(out.list$difs.1[idx,"begin"], YEAR)$YMD
out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V0") -> tmp.V0

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V2") -> tmp.V2

comp.table <- n.comparison(out.list$FinalData.Both, out.list$difs.1, idx, YEAR)

out.list$Data_Out.v2 %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) -> Data_Out.v2.tmp

FF <- Data_Out.v2.tmp[1, "ff"]
data <- get.data("Data/", YEAR, ff = FF)
# the sixth period with 14 whales were not returned from V0

out.list$v0.out$Data_Out %>% filter(ff == FF) -> V0.FF

shift <- 6
out.shift.6 <- get.shift(YEAR, data, ff=FF, i=shift)

# There was no E entry at the end of the file, which might have caused a problem
# in V0 extraction script. That has been fixed. But... sightings 65 and 66 were
# not picked up probably because data were not entered correctly. Needed to edit 
# the data file. _TE added to the file name. 2022-03-21 

```


The data summary for `r fractional_Day2YMDhms(out.list$difs.1[idx, "begin"], YEAR)$YMD` (`r FILES[FF]`) contained `r abs(out.list$difs.1[idx, "total.whales"])` more whales and `r abs(nrow(tmp.V0) - nrow(tmp.V2))` more shift in the output of `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver2.0", "Ver1.0")` than in that of `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver1.0", "Ver2.0")` (Table \@ref(tab:Table-dif-2020-2)).

```{r Table-dif-2020-2, echo=FALSE, warning=FALSE}

flextable(comp.table) %>%
  hline(i = (nrow(comp.table)-1)) %>%
set_caption(paste0("A comparison of results of data extraction for ", YMD, " using Ver1.0 and Ver2.0. n.XXX is the number of observed whales, vs.XXX is the visibility, and BF.XXX is the Beaufort scale, where XXX is either Ver1.0 or Ver2.0")) %>%
  set_table_properties(width = 0.5, layout = "autofit")


```

The last shift (6) was not returned from Ver1.0 extraction. From Ver2.0 extraction, the last shift started at `r fractional_Day2YMDhms(tmp.V2[6, "begin"], YEAR)$hms` and ended at `r fractional_Day2YMDhms(tmp.V2[6, "end"], YEAR)$hms` (`r signif(Data_Out.v2.tmp[6, "dur"], 3)` minutes). A total of `r tmp.V2[6, "n"]` whales were observed during the shift. I don't know why this shift was excluded in the output of Ver1.0. 


#### (3) `r fractional_Day2YMDhms(out.list$difs.1[3,"begin"], YEAR)$YMD` {-}
```{r dif-2020-3, warning=FALSE, include=FALSE, error=FALSE}
idx <- 3
YMD <- fractional_Day2YMDhms(out.list$difs.1[idx,"begin"], YEAR)$YMD
out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V0") -> tmp.V0

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V2") -> tmp.V2

comp.table <- n.comparison(out.list$FinalData.Both, out.list$difs.1, idx, YEAR)
out.list$Data_Out.v2 %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) -> Data_Out.v2.tmp

FF <- Data_Out.v2.tmp[1, "ff"]
data <- get.data("Data/", YEAR, ff = FF)

v0.all.data <- out.list$v0.out$Data_Out

V0.FF <- v0.all.data %>% filter(ff == FF)

# Looking at V0.FF, i = 2 in V0 shows there was no data for that shift.
data %>%  
  filter(begin >= V0.FF[2,"begin"] & begin <= V0.FF[2, "end"]) -> data.FF.i
# there were only two lines: V and E, which should have been part of the 
# first shift. 

# in Vers2.0
out.shift.1 <- get.shift(YEAR, data, ff=FF, i=1)
# The last two lines match with the 2nd shift from Ver1.0

# The difference was caused by Ver1.0 dropping the 4th shift, where Bft and VS
# were NAs.

out.shift.4 <- get.shift(YEAR, data, ff=FF, i=4)
```

The data summary for `r fractional_Day2YMDhms(out.list$difs.1[idx, "begin"], YEAR)$YMD` (`r FILES[FF]`) contained `r abs(out.list$difs.1[idx, "total.whales"])` more whales and `r abs(nrow(tmp.V0) - nrow(tmp.V2))` more shifts in the output of `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver2.0", "Ver1.0")` than in that of `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver1.0", "Ver2.0")` (Table \@ref(tab:Table-dif-2020-3)).


```{r Table-dif-2020-3, echo=FALSE, warning=FALSE}

flextable(comp.table) %>%
  hline(i = (nrow(comp.table)-1)) %>%
set_caption(paste0("A comparison of results of data extraction for ", YMD, " using Ver1.0 and Ver2.0. n.XXX is the number of observed whales, vs.XXX is the visibility, and BF.XXX is the Beaufort scale, where XXX is either Ver1.0 or Ver2.0")) %>%
  set_table_properties(width = 0.5, layout = "autofit")

```

Ver1.0 returned `r nrow(tmp.V0)` shifts whereas Ver2.0 returned `r nrow(tmp.V2)`. Ver1.0 missed the shift from `r fractional_Day2YMDhms(tmp.V2[1, "begin"], YEAR)$hms` to `r fractional_Day2YMDhms(tmp.V2[1, "end"], YEAR)$hms`. Ver1.0 dropped this shift because it did not pick up correct Beaufort and visibility code and returned NAs. Ver2.0 fixed the problem.


### 2022 {-}

#### (1) `r fractional_Day2YMDhms(out.list$difs.1[1,"begin"], YEAR)$YMD` {-}
```{r dif-2022-1, echo=FALSE}
YEAR <- 2022
FILES <- list.files(paste0("Data/", YEAR, "/"))

# update the observer list
obs.list <- out.list$obs.list
if (is.character(obs.list$ID)){
  obs.list$ID <- as.integer(obs.list$ID)
}

out.list <- compare.V0.V2.raw(YEAR, obs.list)

idx <- 1
YMD <- fractional_Day2YMDhms(out.list$difs.1[idx,"begin"], YEAR)$YMD

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V0") -> tmp.V0

out.list$FinalData.Both %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) %>% 
  filter(v == "V2") -> tmp.V2

comp.table <- n.comparison(out.list$FinalData.Both, out.list$difs.1, idx, YEAR)
out.list$Data_Out.v2 %>% 
  filter(time.steps == out.list$difs.1[idx, "time.step"]) -> Data_Out.v2.tmp

FF <- Data_Out.v2.tmp[1, "ff"]
data <- get.data("Data/", YEAR, ff = FF)

out.shift <- get.shift(YEAR, data, ff = FF, i = 2)
# Visibility started at 5 but decreased to 4 within 30 minutes from the beginning
# Should this be included? If it should be included, we should change the data
# file. 

first.rows <- head(out.shift$data.shift) %>%
  select(-c(V15:begin))
```

The data summary for `r fractional_Day2YMDhms(out.list$difs.1[idx, "begin"], YEAR)$YMD` (`r FILES[FF]`) contained `r abs(out.list$difs.1[idx, "total.whales"])` more whales and `r abs(nrow(tmp.V0) - nrow(tmp.V2))` more shifts in the output of `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver2.0", "Ver1.0")` than in that of `r ifelse(out.list$difs.1[idx, "total.whales"] < 0, "Ver1.0", "Ver2.0")` (Table \@ref(tab:Table-dif-2022-1)) .


```{r Table-dif-2022-1, echo=FALSE, warning=FALSE}

flextable(comp.table) %>%
  hline(i = (nrow(comp.table)-1)) %>%
set_caption(paste0("A comparison of results of data extraction for ", YMD, " using Ver1.0 and Ver2.0. n.XXX is the number of observed whales, vs.XXX is the visibility, and BF.XXX is the Beaufort scale, where XXX is either Ver1.0 or Ver2.0")) %>%
  set_table_properties(width = 0.5, layout = "autofit")

```

The output from Ver1.0 contained one extra shift (from `r fractional_Day2YMDhms(tmp.V0[2, "begin"], YEAR)$hms` to `r fractional_Day2YMDhms(tmp.V0[2, "end"], YEAR)$hms`). Ver2.0 showed that maximum visibility during this shift was 5. Visibility of this shift started at 5 but decreased to 4 within 30 minutes from the beginning. If this shift should be included in the analysis, we should change the data file. 


```{r Table-data-2022-1, echo=FALSE, warning=FALSE}
flextable(first.rows) %>% 
  set_caption(paste0("Raw data for ", 
                     fractional_Day2YMDhms(out.list$difs.1[idx, "begin"],
                                           YEAR)$YMD, "between  ",
                     first.rows[1, "V4"], 
                     " and ", first.rows[nrow(first.rows), "V4"], 
                     ", where V1 = event ID, V2 = event code (S = sighting, E = end of shift), V3 = date, V4 = time, V5 = gropu ID, V6 = compass bearing, V7 = reticles, V8 = distance in nm, V9 = group size, V10 = primary observer, V11 = secondary observer, V12 = Beaufort scale, V13  = visibility code, V14 = direction of movement when V2 = 'S', V5 = Beaufort scale and V6 = visibility code when V2 = 'V', V5 and V6 show observers when V2 = 'P'. Event code (V2) = 'B' and 'E' indicate the beginning and end of an observation period, respectively."))  %>%
  set_table_properties(width = 0.5, layout = "autofit")
```

## Abundance estimates {-}

In this section I provide summary statistics for the output from Ver1.0 and Ver2.0 and abundance estimates of gray whales for the 2006/2007 (2007 data), 2007/2008 (2008 data), 2009/2010 (2010 data), 2010/2011 (2011 data), 2014/2015 (2015 data), 2015/2016 (2016 data), 2019/2020 (2020 data), and 2021/2022 (2022 data) seasons. WinBUGS code (Stewart and Weller 2021) was used to fit the N-mixture model (Durban et al. 2016) to the data from the 8 surveys.

### Using outputs from Ver1.0 {-}

```{r Ver1-data, echo=FALSE, warning=FALSE, message= FALSE}
seasons <- c("2006/2007", "2007/2008", "2009/2010", "2010/2011", 
             "2014/2015", "2015/2016", "2019/2020", "2021/2022")

x <- length(seasons)  # 8-year's worth of data. 
Ver1.results <- readRDS(paste0("RData/WinBUGS_", x, "yr_v1.rds"))

n.v1 <- Ver1.results$data$n
whale.counts.v1.df <- data.frame(Season = seasons,
                                 Periods = Ver1.results$data$periods,
                                 Duration = colSums(Ver1.results$data$Watch.Length, 
                                                    na.rm = T) - 2,
                                 Counts = apply(n.v1[,1,], MARGIN = 2, FUN = sum))


# Extract estimated counts
Daily.Est.v1 <- Ver1.results$BUGS_out$sims.list$Daily.Est
sp.v1 <- Ver1.results$BUGS_out$sims.list$sp
com.v1 <- Ver1.results$BUGS_out$sims.list$com
Corrected.Est.v1 <- Ver1.results$BUGS_out$sims.list$Corrected.Est

stats.list.v1 <- vector(mode = "list",
                     length = dim(Daily.Est.v1)[3])

for (k in 1:dim(Daily.Est.v1)[3]){
  # Daily.Est.list[[k]] <- Daily.Est[,,k]
  # Daily.Est.UCIs[[k]] <- apply(Daily.Est[,,k],2,quantile,0.975)
  # Daily.Est.LCIs[[k]] <- apply(Daily.Est[,,k],2,quantile,0.275)
  # 
  # sp.list[[k]] <- sp[,,k]
  # com.list[[k]] <- com[,,k]
  
  stats.list.v1[[k]] <- data.frame(Daily.Est.median = apply(Daily.Est.v1[,,k], 2,
                                                         median),
                                Daily.Est.LCL = apply(Daily.Est.v1[,,k], 2,
                                                      quantile,0.275),
                                Daily.Est.UCL = apply(Daily.Est.v1[,,k], 2,
                                                      quantile,0.975),
                                sp.median = apply(exp(sp.v1[,,k]), 2,
                                                  median),
                                sp.LCL = apply(exp(sp.v1[,,k]), 2,
                                               quantile,0.025),
                                sp.UCL = apply(exp(sp.v1[,,k]), 2,
                                               quantile,0.975),
                                com.median = apply(exp(com.v1[,,k]), 2,
                                                   median),
                                com.LCL = apply(exp(com.v1[,,k]), 2,
                                                quantile,0.025),
                                com.UCL = apply(exp(com.v1[,,k]), 2,
                                                quantile,0.975),
                                #total.median = apply(exp(sp[,,k]), 1, sum),
                                days = 1:dim(Daily.Est.v1)[2],
                                year = seasons[k])
}

all.stats.v1 <- do.call("rbind", stats.list.v1) %>% group_by(year)

abundance.df.v1 <- data.frame(Season = seasons, 
                              Median = apply(Corrected.Est.v1, 
                                                FUN = median, 
                                                MARGIN = 2),
                           LCL = apply(Corrected.Est.v1, 
                                             MARGIN = 2, 
                                             FUN = quantile, 0.025),
                           UCL = apply(Corrected.Est.v1, 
                                             MARGIN = 2, 
                                             FUN = quantile, 0.975))

p.Nhat.v1 <- ggplot(data = abundance.df.v1) + 
  geom_point(aes(x = Season, y = Median)) + 
  geom_errorbar(aes(x = Season, ymin = LCL, ymax = UCL)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  xlab("") +
  ylab("Median abundance + 95% CI")

if (save.fig)
  ggsave(filename = "figures/nhats_v1.png", plot = p.Nhat.v1,
         device = "png", dpi = 600)

p.v1.both <- ggplot(data = all.stats.v1) + 
  geom_line(aes(x = days, y = sp.median),
            color = "darkblue") + 
  geom_line(aes(x = days, y = com.median),
            color = "red") +
  geom_ribbon(aes(x = days, 
                  ymin = sp.LCL, 
                  ymax = sp.UCL),
              fill = "lightblue", 
              alpha = 0.5) +
  geom_line(aes(x = days, y = com.median),
            color = "indianred1") +
  facet_wrap(vars(year)) +
  xlab("Days since December 1") + 
  ylab("Whales per day")

if (save.fig)
  ggsave(filename = "figures/SPvsNormal_v1.png", plot = p.v1.both,
         device = "png", dpi = 600)

p.v1.daily <- 
  ggplot(data = all.stats.v1) +
  geom_line(aes(x = days, y = Daily.Est.median)) +
  geom_ribbon(aes(x = days, 
                  ymin = Daily.Est.LCL, 
                  ymax = Daily.Est.UCL),
              fill = "orange", 
              alpha = 0.5) + 
  facet_wrap(vars(year))+
  xlab("Days since December 1") + 
  ylab("Whales per day")

if (save.fig)
  ggsave(filename = "figures/daily_estimates_v1.png", plot = p.v1.daily,
         device = "png", dpi = 600)


```

The output of Ver1.0 included `r min(whale.counts.v1.df$Periods)` to `r max(whale.counts.v1.df$Periods)` survey periods, where a survey period is between 85 and 95 minutes with some exceptions described above (Table \@ref(tab:Table-effort-v1)). The observed number of whales ranged from `r min(whale.counts.v1.df$Counts)` in the `r whale.counts.v1.df[whale.counts.v1.df$Counts == min(whale.counts.v1.df$Counts), "Season"]` season to `r max(whale.counts.v1.df$Counts)` in the `r whale.counts.v1.df[whale.counts.v1.df$Counts == max(whale.counts.v1.df$Counts), "Season"]` season. 


```{r Table-effort-v1, echo=FALSE}
flextable(whale.counts.v1.df) %>% 
  set_caption(paste0("Survey effort between the 2006/2007 and 2021/2022 seasons when Ver1.0 extraction code was used. Periods are the number of suvey periods (minimum of 85 and maximum of 95 minutes, Duration is in days, and the total numbers of observed whales are in Counts."))  %>%
  set_table_properties(width = 0.5, layout = "autofit")
```


Using Ver1.0 extraction code, the abundance of gray whales during the 2021/2022 season was `r format(abundance.df.v1[nrow(abundance.df.v1), "Median"], scientific=F, digits = 6)` (95% CI: `r format(abundance.df.v1[nrow(abundance.df.v1), "LCL"], scientific=F, digits = 6)` - `r format(abundance.df.v1[nrow(abundance.df.v1), "UCL"], scientific=F, digits = 6)`). This estimate includes the multiplicative correction factor for the nighttime passage (mean = 1.0875, SD = 0.03625). This estimate was `r signif((abundance.df.v1[nrow(abundance.df.v1), "Median"] - abundance.df.v1[(nrow(abundance.df.v1)-1), "Median"])/abundance.df.v1[(nrow(abundance.df.v1)-1), "Median"], 3) * 100`% decline from the previous survey season (2019/2020, Figure \@ref(fig:Figure-nhats-v1), Table \@ref(tab:Table-nhats-v1)). 


```{r Table-nhats-v1, echo=FALSE, warning=FALSE}
flextable(abundance.df.v1) %>% 
  set_caption(paste0("Estimated abundance (Median) and 95% lower (LCL) and upper (UCL) credible intervals of gray whales from the visual surveys off Granite Canyon, CA, between the 2006/2007 and 2021/2022 seasons and Ver2.0 extraction code."))  %>%
  set_table_properties(width = 0.5, layout = "autofit")
```


```{r Figure-nhats-v1, echo=FALSE, message=FALSE, fig.cap="Estimated abundance and 95% credible intervals of gray whales from the visual surveys off Granite Canyon, CA, between the 2006/2007 and 2021/2022 seasons."}

knitr::include_graphics("figures/nhats_v1.png")

```


### Using outputs from Ver2.0 {-}

```{r Ver2-data, echo=FALSE, warning=FALSE, message= FALSE}
Ver2.results <- readRDS(paste0("RData/WinBUGS_", x, "yr_v2.rds"))

n.v2 <- Ver2.results$data$n
whale.counts.v2.df <- data.frame(Season = seasons,
                                 Periods = Ver2.results$data$periods,
                                 Duration = colSums(Ver2.results$data$Watch.Length, 
                                                    na.rm = T) - 2,
                                 Counts = apply(n.v2[,1,], MARGIN = 2, FUN = sum))


# Extract estimated counts
Daily.Est.v2 <- Ver2.results$BUGS_out$sims.list$Daily.Est
sp.v2 <- Ver2.results$BUGS_out$sims.list$sp
com.v2 <- Ver2.results$BUGS_out$sims.list$com
Corrected.Est.v2 <- Ver2.results$BUGS_out$sims.list$Corrected.Est

stats.list.v2 <- vector(mode = "list",
                     length = dim(Daily.Est.v2)[3])

for (k in 1:dim(Daily.Est.v2)[3]){
  # Daily.Est.list[[k]] <- Daily.Est[,,k]
  # Daily.Est.UCIs[[k]] <- apply(Daily.Est[,,k],2,quantile,0.975)
  # Daily.Est.LCIs[[k]] <- apply(Daily.Est[,,k],2,quantile,0.275)
  # 
  # sp.list[[k]] <- sp[,,k]
  # com.list[[k]] <- com[,,k]
  
  stats.list.v2[[k]] <- data.frame(Daily.Est.median = apply(Daily.Est.v2[,,k], 2,
                                                         median),
                                Daily.Est.LCL = apply(Daily.Est.v2[,,k], 2,
                                                      quantile,0.275),
                                Daily.Est.UCL = apply(Daily.Est.v2[,,k], 2,
                                                      quantile,0.975),
                                sp.median = apply(exp(sp.v2[,,k]), 2,
                                                  median),
                                sp.LCL = apply(exp(sp.v2[,,k]), 2,
                                               quantile,0.025),
                                sp.UCL = apply(exp(sp.v2[,,k]), 2,
                                               quantile,0.975),
                                com.median = apply(exp(com.v2[,,k]), 2,
                                                   median),
                                com.LCL = apply(exp(com.v2[,,k]), 2,
                                                quantile,0.025),
                                com.UCL = apply(exp(com.v2[,,k]), 2,
                                                quantile,0.975),
                                #total.median = apply(exp(sp[,,k]), 1, sum),
                                days = 1:dim(Daily.Est.v2)[2],
                                year = seasons[k])
}

all.stats.v2 <- do.call("rbind", stats.list.v2) %>% group_by(year)

abundance.df.v2 <- data.frame(Season = seasons, 
                              Median = apply(Corrected.Est.v2, 
                                                FUN = median, 
                                                MARGIN = 2),
                           LCL = apply(Corrected.Est.v2, 
                                             MARGIN = 2, 
                                             FUN = quantile, 0.025),
                           UCL = apply(Corrected.Est.v2, 
                                             MARGIN = 2, 
                                             FUN = quantile, 0.975))

p.Nhat.v2 <- ggplot(data = abundance.df.v2) + 
  geom_point(aes(x = Season, y = Median)) + 
  geom_errorbar(aes(x = Season, ymin = LCL, ymax = UCL)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  xlab("") +
  ylab("Median abundance + 95% CI")

if (save.fig)
  ggsave(filename = "figures/nhats_v2.png", plot = p.Nhat.v2,
         device = "png", dpi = 600)

p.v2.both <- ggplot(data = all.stats.v2) + 
  geom_line(aes(x = days, y = sp.median),
            color = "darkblue") + 
  geom_line(aes(x = days, y = com.median),
            color = "red") +
  geom_ribbon(aes(x = days, 
                  ymin = sp.LCL, 
                  ymax = sp.UCL),
              fill = "lightblue", 
              alpha = 0.5) +
  geom_line(aes(x = days, y = com.median),
            color = "indianred1") +
  facet_wrap(vars(year)) +
  xlab("Days since December 1") + 
  ylab("Whales per day")

if (save.fig)
  ggsave(filename = "figures/SPvsNormal_v2.png", plot = p.v2.both,
         device = "png", dpi = 600)

p.v2.daily <- 
  ggplot(data = all.stats.v2) +
  geom_line(aes(x = days, y = Daily.Est.median)) +
  geom_ribbon(aes(x = days, 
                  ymin = Daily.Est.LCL, 
                  ymax = Daily.Est.UCL),
              fill = "orange", 
              alpha = 0.5) + 
  facet_wrap(vars(year))+
  xlab("Days since December 1") + 
  ylab("Whales per day")

if (save.fig)
  ggsave(filename = "figures/daily_estimates_v2.png", plot = p.v2.daily,
         device = "png", dpi = 600)


```

The output of Ver2.0 included `r min(whale.counts.v2.df$Periods)` to `r max(whale.counts.v2.df$Periods)` survey periods, where a survey period is between 85 and 95 minutes with some exceptions described above (Table \@ref(tab:Table-effort-v2)). The observed number of whales ranged from `r min(whale.counts.v2.df$Counts)` in the `r whale.counts.v2.df[whale.counts.v2.df$Counts == min(whale.counts.v2.df$Counts), "Season"]` season to `r max(whale.counts.v2.df$Counts)` in the `r whale.counts.v2.df[whale.counts.v2.df$Counts == max(whale.counts.v2.df$Counts), "Season"]` season. 


```{r Table-effort-v2, echo=FALSE}
flextable(whale.counts.v2.df) %>% 
  set_caption(paste0("Survey effort between the 2006/2007 and 2021/2022 seasons when Ver2.0 extraction code was used. Periods are the number of suvey periods (minimum of 85 and maximum of 95 minutes, Duration is in days, and the total numbers of observed whales are in Counts."))  %>%
  set_table_properties(width = 0.5, layout = "autofit")
```


Using Ver2.0 extraction code, the abundance of gray whales during the 2021/2022 season was `r format(abundance.df.v2[nrow(abundance.df.v2), "Median"], scientific=F, digits = 6)` (95% CI: `r format(abundance.df.v2[nrow(abundance.df.v2), "LCL"], scientific=F, digits = 6)` - `r format(abundance.df.v2[nrow(abundance.df.v2), "UCL"], scientific=F, digits = 6)`). This estimate includes the multiplicative correction factor for the nighttime passage (mean = 1.0875, SD = 0.03625). This estimate was `r signif((abundance.df.v2[nrow(abundance.df.v2), "Median"] - abundance.df.v2[(nrow(abundance.df.v2)-1), "Median"])/abundance.df.v2[(nrow(abundance.df.v2)-1), "Median"], 3) * 100`% decline from the previous survey season (2019/2020, Figure \@ref(fig:Figure-nhats-v2), Table \@ref(tab:Table-nhats-v2)). 


```{r Table-nhats-v2, echo=FALSE, warning=FALSE}
flextable(abundance.df.v2) %>% 
  set_caption(paste0("Estimated abundance (Median) and 95% lower (LCL) and upper (UCL) credible intervals of gray whales from the visual surveys off Granite Canyon, CA, between the 2006/2007 and 2021/2022 seasons and Ver2.0 extraction code."))  %>%
  set_table_properties(width = 0.5, layout = "autofit")
```

\newline

```{r Figure-nhats-v2, echo=FALSE, message=FALSE, fig.cap="Estimated abundance and 95% credible intervals of gray whales from the visual surveys off Granite Canyon, CA, between the 2006/2007 and 2021/2022 seasons and Ver2.0 extraction code."}

knitr::include_graphics("figures/nhats_v2.png")

```


