---
title: "Gray whale abundance estimates update (2022)"
author: "Tomo Eguchi"
date: "`r Sys.Date()`"
output: 
  bookdown::word_document2: default
---

```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
save.fig <- F

source("Granite_Canyon_Counts_fcns.R")
library(tidyverse)
library(lubridate)
library(flextable)

set_flextable_defaults(font.size = 9,
                       font.family = "Cambria")
# some constants here:
# # periods for the 6 survey years
periods <-c(136, 135, 164, 178, 179, 151)

# Observer list gets updated as new observers are added. 
obs.list <- read.csv("Data/Observer list.csv", header = T) 
colnames(obs.list) <- c("obs", "ID")

seasons <- c("2006/2007", "2007/2008", "2009/2010", "2010/2011", 
             "2014/2015", "2015/2016", "2019/2020", "2021/2022")

x <- length(seasons)
```

## Introduction {-}

In this document, I provide the estimated abundance and migration phenology of gray whales from the data collected at Granite Canyon, CA. I used the same statistical model (N-mixture model; Durban et al. 2016) as in the previous years (e.g., Stewart and Weller 2021). 

## Abundance estimates {-}

In this section I provide summary statistics for the output from Ver2.0 and abundance estimates of gray whales for the 2006/2007 (2007 data), 2007/2008 (2008 data), 2009/2010 (2010 data), 2010/2011 (2011 data), 2014/2015 (2015 data), 2015/2016 (2016 data), 2019/2020 (2020 data), and 2021/2022 (2022 data) seasons. WinBUGS code (Stewart and Weller 2021) was used to fit the N-mixture model (Durban et al. 2016) to the data from the 8 surveys.

NEED TO USE THE MOST RECENT OUTPUT FILE IN THE DESKTOP COMPTUER

```{r Ver2-data, echo=FALSE, warning=FALSE, message= FALSE}

# CHANGE THIS LINE BACK
#Ver2.results <- readRDS(paste0("RData/WinBUGS_", x, "yr_v2.rds"))
Ver2.results <- readRDS(paste0("RData/WinBUGS_", x, "yr_100k_v2.rds"))

# observed counts:
n.v2 <- Ver2.results$jags.data$n
whale.counts.v2.df <- data.frame(Season = seasons,
                                 Periods = Ver2.results$jags.data$periods,
                                 #Duration = colSums(Ver2.results$jags.data$Watch.Length, 
                                #                    na.rm = T) - 2,
                                 Counts = apply(n.v2[,1,], MARGIN = 2, FUN = sum))

whale.counts.df <- data.frame(Season = seasons,
                              Periods.v2 = Ver2.results$jags.data$periods,
                              Counts.V2 = apply(n.v2[,1,], MARGIN = 2, FUN = sum))

# Extract estimated counts
Daily.Est.v2 <- Ver2.results$BUGS_out$sims.list$Daily.Est
sp.v2 <- Ver2.results$BUGS_out$sims.list$sp
com.v2 <- Ver2.results$BUGS_out$sims.list$com
Corrected.Est.v2 <- Ver2.results$BUGS_out$sims.list$Corrected.Est

stats.list.v2 <- vector(mode = "list",
                     length = dim(Daily.Est.v2)[3])

for (k in 1:dim(Daily.Est.v2)[3]){
  # Daily.Est.list[[k]] <- Daily.Est[,,k]
  # Daily.Est.UCIs[[k]] <- apply(Daily.Est[,,k],2,quantile,0.975)
  # Daily.Est.LCIs[[k]] <- apply(Daily.Est[,,k],2,quantile,0.275)
  # 
  # sp.list[[k]] <- sp[,,k]
  # com.list[[k]] <- com[,,k]
  
  stats.list.v2[[k]] <- data.frame(Daily.Est.median = apply(Daily.Est.v2[,,k], 2,
                                                            median),
                                   Daily.Est.LCL = apply(Daily.Est.v2[,,k], 2,
                                                         quantile,0.275),
                                   Daily.Est.UCL = apply(Daily.Est.v2[,,k], 2,
                                                         quantile,0.975),
                                   sp.median = apply(exp(sp.v2[,,k]), 2,
                                                     median),
                                   sp.LCL = apply(exp(sp.v2[,,k]), 2,
                                                  quantile,0.025),
                                   sp.UCL = apply(exp(sp.v2[,,k]), 2,
                                                  quantile,0.975),
                                   com.median = apply(exp(com.v2[,,k]), 2,
                                                      median),
                                   com.LCL = apply(exp(com.v2[,,k]), 2,
                                                   quantile,0.025),
                                   com.UCL = apply(exp(com.v2[,,k]), 2,
                                                   quantile,0.975),
                                   #total.median = apply(exp(sp[,,k]), 1, sum),
                                   days = 1:dim(Daily.Est.v2)[2],
                                   year = seasons[k])
}

all.stats.v2 <- do.call("rbind", stats.list.v2) %>% group_by(year)

abundance.df.v2 <- data.frame(Season = seasons, 
                              Median = apply(Corrected.Est.v2, 
                                             FUN = median, 
                                             MARGIN = 2),
                              LCL = apply(Corrected.Est.v2, 
                                          MARGIN = 2, 
                                          FUN = quantile, 0.025),
                              UCL = apply(Corrected.Est.v2, 
                                          MARGIN = 2, 
                                          FUN = quantile, 0.975))

p.Nhat.v2 <- ggplot(data = abundance.df.v2) + 
  geom_point(aes(x = Season, y = Median)) + 
  geom_errorbar(aes(x = Season, ymin = LCL, ymax = UCL)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  xlab("") +
  ylab("Median abundance + 95% CI")

if (save.fig)
  ggsave(filename = "figures/nhats_v2.png", plot = p.Nhat.v2,
         device = "png", dpi = 600)

p.v2.both <- ggplot(data = all.stats.v2) + 
  geom_line(aes(x = days, y = sp.median),
            color = "darkblue") + 
  geom_line(aes(x = days, y = com.median),
            color = "red") +
  geom_ribbon(aes(x = days, 
                  ymin = sp.LCL, 
                  ymax = sp.UCL),
              fill = "lightblue", 
              alpha = 0.5) +
  geom_line(aes(x = days, y = com.median),
            color = "indianred1") +
  facet_wrap(vars(year)) +
  xlab("Days since December 1") + 
  ylab("Whales per day")

if (save.fig)
  ggsave(filename = "figures/SPvsNormal_v2.png", plot = p.v2.both,
         device = "png", dpi = 600)

p.v2.daily <- 
  ggplot(data = all.stats.v2) +
  geom_line(aes(x = days, y = Daily.Est.median)) +
  geom_ribbon(aes(x = days, 
                  ymin = Daily.Est.LCL, 
                  ymax = Daily.Est.UCL),
              fill = "orange", 
              alpha = 0.5) + 
  facet_wrap(vars(year))+
  xlab("Days since December 1") + 
  ylab("Whales per day")

if (save.fig)
  ggsave(filename = "figures/daily_estimates_v2.png", plot = p.v2.daily,
         device = "png", dpi = 600)


p.v2.sp.daily <- 
  ggplot(data = all.stats.v2) +
  geom_line(aes(x = days, y = sp.median)) +
  geom_ribbon(aes(x = days, 
                  ymin = sp.LCL, 
                  ymax = sp.UCL),
              fill = "orange", 
              alpha = 0.5) + 
  facet_wrap(vars(year))+
  xlab("Days since December 1") + 
  ylab("Whales per day")

if (save.fig)
  ggsave(filename = "figures/sp_estimates_v2.png", 
         plot = p.v2.sp.daily,
         device = "png", dpi = 600)


```


Using Ver2.0 extraction code, the abundance of gray whales during the 2021/2022 season was `r format(abundance.df.v2[nrow(abundance.df.v2), "Median"], scientific=F, digits = 6)` (95% CI: `r format(abundance.df.v2[nrow(abundance.df.v2), "LCL"], scientific=F, digits = 6)` - `r format(abundance.df.v2[nrow(abundance.df.v2), "UCL"], scientific=F, digits = 6)`). This estimate includes the multiplicative correction factor for the nighttime passage (mean = 1.0875, SD = 0.03625). This estimate was `r signif((abundance.df.v2[nrow(abundance.df.v2), "Median"] - abundance.df.v2[(nrow(abundance.df.v2)-1), "Median"])/abundance.df.v2[(nrow(abundance.df.v2)-1), "Median"], 3) * 100`% decline from the previous survey season (2019/2020, Figure \@ref(fig:Figure-nhats-v2), Table \@ref(tab:Table-nhats-v1-v2)). 


```{r Table-nhats-v2, echo=FALSE, warning=FALSE}
flextable(abundance.df.v2) %>% 
  set_caption(paste0("Estimated abundance (Median) and 95% lower (LCL) and upper (UCL) credible intervals of gray whales from the visual surveys off Granite Canyon, CA, between the 2006/2007 and 2021/2022 seasons."))  %>%
  set_table_properties(width = 0.5, layout = "autofit")
```


```{r Figure-nhats-v2, echo=FALSE, message=FALSE, fig.cap="Estimated abundance and 95% credible intervals of gray whales from the visual surveys off Granite Canyon, CA, between the 2006/2007 and 2021/2022 seasons and Ver2.0 extraction code."}

knitr::include_graphics("figures/nhats_v2.png")

```


## Migration phenology {-}

In this section, I look at how timing of migration may have changed over the years. I only use the output of Ver2.0 for this analysis. The median date is defined as "the peak of the southbound migration is defined here as the date when 50% of the whale sightings had been recorded at a research site or (if data were not available for calculating the median) the date corresponding with the apex of a unimodal sighting curve (e.g. Fig. 2)." (Rough et al. 2001). Using the first definition, these dates correspond to sightings, rather than abundance estimates, whereas the latter definition is applicable for estimated numbers, if the model has a unimodal distribution. In our case, the model selected a better estimate between normal and spline fits for each day. Consequently, the results are not unimodal for some years (Figure \@ref(fig:Figure-daily-fit)). I use the date when 50% of the whale sightings had been recorded as the median date.   

```{r Figure-daily-fit, echo=FALSE, message=FALSE, fig.cap="Daily estimated numbers of gray whales migrating through the sampling area off Granite Canyon. Black lines are medians and orange bands indicate 95% credible intervals."}

knitr::include_graphics("figures/daily_estimates_v2.png")

```


```{r timing1, echo=FALSE}

obsd.n <- n.v2[,1,]
total.n <- colSums(obsd.n)
median.n <- floor(total.n/2)
cumsum.n <- apply(obsd.n, MARGIN = 2, FUN = cumsum)
median.idx <- vector(mode = "numeric", length = x )
k <- 1
idx.vec <- seq(1, nrow(obsd.n))
for (k in 1:x){
  tmp <- cumsum.n[,k]
  dif.k <- abs(tmp - median.n[k])
  median.idx[k] <- idx.vec[dif.k == min(dif.k)]
}

median.idx.df <- data.frame(Season = seasons,
                            median.idx = median.idx)
obsd.n.df <- data.frame(obsd.n)

obsd.n.cumsum.df <- apply(obsd.n, MARGIN = 2, cumsum) %>% data.frame()
colnames(obsd.n.df) <- seasons
colnames(obsd.n.cumsum.df) <- seasons
#obsd.n.df$days <- idx.vec
obsd.n.df.long <- pivot_longer(obsd.n.df, everything(),
                               names_to = "Season", 
                               values_to = "Counts") %>%  
  arrange(Season)

obsd.n.df.long$days <- rep(1:nrow(obsd.n), times = x)

obsd.n.cumsum.df.long <- pivot_longer(obsd.n.cumsum.df, everything(),
                               names_to = "Season", 
                               values_to = "Counts") %>%  
  arrange(Season)

obsd.n.cumsum.df.long$days <- rep(1:nrow(obsd.n), times = x)

p.obsd.n <- ggplot(obsd.n.df.long) +
  geom_path(aes(x = days, y = Counts)) +
  facet_wrap(vars(Season)) + 
  geom_vline(data = median.idx.df,
             aes(xintercept = median.idx),
             color = "red", size = 1)

if (save.fig)
  ggsave(filename = "figures/phenology.png",
         device = "png", dpi = 600)

p.obsd.n.cumu <- ggplot(obsd.n.cumsum.df.long) +
  geom_path(aes(x = days, y = Counts)) +
  facet_wrap(vars(Season)) + 
  geom_vline(data = median.idx.df,
             aes(xintercept = median.idx),
             color = "red", size = 1) +
  ylab("Cumulative counts")

if (save.fig)
  ggsave(filename = "figures/phenology_cumsum.png",
         device = "png", dpi = 600)

```

Median date changed widely among years. It ranged from `r min(median.idx)` in `r median.idx.df[median.idx == min(median.idx), "Season"]` to `r max(median.idx)` in `r median.idx.df[median.idx == max(median.idx), "Season" ]` (Figure \@ref(fig:Figure-phenology)).

```{r Figure-phenology, echo=FALSE, message=FALSE, fig.cap="Daily observed numbers of gray whales migrating through the sampling area off Granite Canyon. Red vertical lines indicate the median date (the date when 50% of the whale sightings had been recorded)."}

knitr::include_graphics("figures/phenology.png")


```

