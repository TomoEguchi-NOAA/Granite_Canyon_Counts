---
title: "A new approach to gray whale abundance estimation"
author: "Tomo Eguchi"
date: "`r Sys.Date()`"
output: 
  bookdown::word_document2: default
---


```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
save.fig <- F

source("Granite_Canyon_Counts_fcns.R")
library(tidyverse)
library(lubridate)
library(flextable)
library(jagsUI)

set_flextable_defaults(font.size = 9,
                       font.family = "Cambria")
```

## Introduction {-}

Analytical methods to estimate abundance of gray whales from visual surveys at Granite Canyon, CA, have evolved over the years. Laake et al. (2006?) used the distance sampling approach with generalized additive models (GAMs). Durban et al. (2016) developed a new method using a Bayesian N-mixture approach. The new approach was approved by the IWC and it has been used for the analysis since the 2015/2016 season. The analysis is conducted using WinBUGS, which has become obsolete over the last several years. In this report, I provide improvements of the method by Durban et al. where the analysis is conducted using JAGS (Plummer 2021), which is a widely used Bayesian programming language. 

The general tendency of annual migration of gray whales (or any other migratory species - find other examples) is that when the migration is observed at a location along the migration corridor, the number increases over time until it reaches its peak, then it decreases. The method by Durban et al. used a Gaussian function to capture this general trend. 

In the following, I first describe the method by Durban et al. and point out underlying assumptions that are somewhat questionable. Then, I introduce a new approach that is consistent with the basic idea of the method by Durban et al. but improve it by removing those assumptions. I show the performance of the new approach using simulated data. Finally, I reanalyze the data to compare abundance estimates between the two approaches. 


## Method by Durban et al. {-}

### Mathematical description {-}


### Difficulties of the method {-}

The approach used the "cut" function within WinBUGS to select either Gaussian or spline fit to daily count of gray whales. The use of "cut" function has been criticized (Plummer YR). Furthermore, the assumption that the number of gray whales migrating in front of the observation station follows a Gaussian function is somewhat questionable. The true curve may not be symmetrical around the peak and the peak may not be instantaneous. In other words, the peak may persist for a few days. Fitting spline functions to observed counts alleviates the problem but it loses the general idea that the number of whales increases, reaches a peak, then decreases over the migration season.  

## Improvements {-}

### Model description
In order to overcome these difficulties with the previous approach, I propose to use a more flexible function that can accommodate the general shape (increase, peak then decrease) and asymmetrical around the peak. The function is often called Richards' function and it has the following form.

$$M_1 = (1 + (2 e^K - 1) * e^{(P-d)/(S_1)}) ^ {(-1/e^K)}$$

$$M_2 = (1 + (2 e^K - 1) * e^{(P-d)/(S_2)}) ^ {(-1/e^K)}$$

$$N = N_{min} + (N_{max} - N_{min}) * (M_1 * M_2),$$ 

where $d$ is the number of days from the beginning of nesting season,

$S_1 < 0$ and $S_2 > 0$ defines how the slope decreases and increases, respectively,

$K > 0$ defines the "flatness" at the peak of the function,

$P$ defines where the peak is relative to the range of $d$, where $min(d) < P < max(d)$,

$N_{min}$ is zero, i.e., the number of whales migrating outside of a migration season and,

$N_{max} >> N_{min}$. $N_{max}$ is not the maximum number of whales migrating per day but it is a parameter that may be fixed or estimated during the analysis.  


### Function characteristics {-}

#### Effects of $S_1$ {-}

The parameter $S_1 < 0$ defines how the curve decreases from its peak. The rate of decline slows down as $S_1$ becomes smaller (Figure \@ref(fig:Figure-S1)). Because we make an assumption that there are no whales migrating at day 1 and 90, the lower bound of $S_1$ can be restricted to a certain value, e.g., -5).   

```{r S1, echo=FALSE, message=FALSE}
S1 <- c(-10, -5, -2.5, -1.2, -0.6, -0.3)
S2 <- 1.5
K <- 1
P <- 40
max.N <- 800

true.mean.N <- matrix(data = 0, nrow = 90, ncol = length(S1))

for (c in 1:length(S1)){
  for (d in 1:90){
    true.mean.N[d, c] <- floor(Richards_fcn(d = d, 
                                            S1 = S1[c], 
                                            S2 = S2,
                                            K = K, 
                                            P = P, 
                                            min = 0, max = max.N)  )
    

  }
  
}

data.df <- data.frame(Day = rep(1:90, times = length(S1)),
                      mean.N = as.vector(true.mean.N),
               
                      S1 = rep(S1, each = 90))

p.S1 <- ggplot(data = data.df) +
  geom_path(aes(x = Day, y = mean.N), color = "red") +

  facet_wrap(~ S1)

ggsave(p.S1, filename = "figures/S1.png", dpi = 600, device = "png")

```



```{r Figure-S1, echo=FALSE, message=FALSE, fig.cap="Effects of $S_1$. In this example, $S_2 = 1.5$, $K = 1$, $P = 40$, $N_{max} = 800$."}

knitr::include_graphics("figures/S1.png")

```


#### Effects of $S_2$ {-}

The parameter $S_2 > 0$ defines how the curve increases to its peak. The rate of increase slows down as $S_2$ becomes larger (Figure \@ref(fig:Figure-S2)). Because we make an assumption that there are no whales migrating at day 1 and 90, the upper bound of $S_2$ can be restricted to a certain value, e.g., 5).

```{r S2, echo=FALSE, message=FALSE}
S1 <- -1.5
S2 <- c(0.3, 0.6, 1.2, 2.5, 5, 10)
K <- 1
P <- 40
max.N <- 800

true.mean.N <- matrix(data = 0, nrow = 90, ncol = length(S2))

for (c in 1:length(S2)){
  for (d in 1:90){
    true.mean.N[d, c] <- floor(Richards_fcn(d = d, 
                                            S1 = S1, 
                                            S2 = S2[c],
                                            K = K, 
                                            P = P, 
                                            min = 0, max = max.N)  )
    
  }
  
}

data.df <- data.frame(Day = rep(1:90, times = length(S2)),
                      mean.N = as.vector(true.mean.N),

                      S2 = rep(S2, each = 90))

p.S2 <- ggplot(data = data.df) +
  geom_path(aes(x = Day, y = mean.N), color = "red") +

  facet_wrap(~ S2)


ggsave(p.S2, filename = "figures/S2.png", dpi = 600, device = "png")

```


```{r Figure-S2, echo=FALSE, message=FALSE, fig.cap="Effects of $S_2$. In this example, $S_1 = -1.5$, $K = 1$, $P = 40$, $N_{max} = 800$."}

knitr::include_graphics("figures/S2.png")

```


#### Effects of K {-}

The parameter $K > 0$ defines the flatness of the curve at its peak. Greater $K$ values correspond to flatter peaks (Figure \@ref(fig:Figure-K)). Similarly to $S_1$ and $S_2$, the upper bound of $K$ may be defined based on the assumption that the numbers of migrating gray whales are zero at day 1 and 90, e.g., $K < 2$. 

```{r K, echo=FALSE, message=FALSE}
S1 <- -2.5
S2 <- 2.5
K <- c(0.01, 0.1, 1, 2, 4, 8)
P <- 40
max.N <- 800

true.mean.N <- matrix(data = 0, nrow = 90, 
                           ncol = length(K))

for (c in 1:length(K)){
  for (d in 1:90){
    true.mean.N[d, c] <- floor(Richards_fcn(d = d, 
                                            S1 = S1, 
                                            S2 = S2,
                                            K = K[c], 
                                            P = P, 
                                            min = 0, max = max.N)  )
    
  }
  
}

data.df <- data.frame(Day = rep(1:90, times = length(K)),
                      mean.N = as.vector(true.mean.N),
                      K = rep(K, each = 90))

p.K <- ggplot(data = data.df) +
  geom_path(aes(x = Day, y = mean.N), color = "red") +
  facet_wrap(~ K)

ggsave(p.K, filename = "figures/K.png", dpi = 600, device = "png")

```


```{r Figure-K, echo=FALSE, message=FALSE, fig.cap="Effects of $K$. In this example, $S_1 = -2.5$, $S_2 = 2.5$, $P = 40$, $N_{max} = 800$."}

knitr::include_graphics("figures/K.png")

```



#### Effects of P {-}

The parameter $P$ defines the location of its peak (Figure \@ref(fig:Figure-P)). 

```{r P, echo=FALSE, message=FALSE}
S1 <- -2.5
S2 <- 2.5
K <- 1.5
P <- c(20, 40, 60, 80)
max.N <- 800

true.mean.N <- matrix(data = 0, nrow = 90, 
                           ncol = length(P))

for (c in 1:length(P)){
  for (d in 1:90){
    true.mean.N[d, c] <- floor(Richards_fcn(d = d, 
                                            S1 = S1, 
                                            S2 = S2,
                                            K = K, 
                                            P = P[c], 
                                            min = 0, max = max.N)  )
    
  }
  
}

data.df <- data.frame(Day = rep(1:90, times = length(P)),
                      mean.N = as.vector(true.mean.N),
                      P = rep(P, each = 90))

p.P <- ggplot(data = data.df) +
  geom_path(aes(x = Day, y = mean.N), color = "red") +
  facet_wrap(~ P)

ggsave(p.P, filename = "figures/P.png", dpi = 600, device = "png")

```


```{r Figure-P, echo=FALSE, message=FALSE, fig.cap="Effects of $P$. In this example, $S_1 = -2.5$, $S_2 = 2.5$, $K = 1.5$, $N_{max} = 800$."}

knitr::include_graphics("figures/P.png")

```


#### Fitting the model to observed counts {-}

The proposed new approach replaces the spline-Gaussian selection step in Durban et al. with Richards functions. The observed counts are modeled with binomial distributions as it was in Durban et al.

$$ n_{d_t,s,y} \sim BIN(N_{t, y}, p_{d_t, s, y} * \theta_{d_t, y}) $$
where $n_{d_t, s, y}$ is the observed number of gray whales during the watch period $d$ of the $t$-th day of the season $y$ from the station $s$, $N_{t, y}$ is the number of gray whales that migrated through the sampling area during the $t$-th day,  $p_{d_t, s, y}$ is the sighting probability of the station $s$ during the watch period $d$ of the $t$-th day of the season $y$, and $\theta_{d_t,y}$ is the fractional duration of the watch period $d_t$ to the total possible (9 hrs), e.g., 3 hrs equals to 3/9 = 0.3.

The sighting probability $p_{d_t, s, y}$ is modeled as a function of Beaufort sea state, visibility, and observers. Beaufort sea state and visibility were treated as fixed effects, whereas observers were treated as a random effect. Furthermore, additional parameters were added to determine whether or not to include any of these covariates. 


$$ logit(p_{d_t, s, y}) = \beta_0 + I_{BF} * \beta_{BF} * BF_{d_t, y} + I_{VS} * \beta_{VS} * VS_{d_t, y} + I_{OBS} * OBS_{d_t, s, y}  $$

This is identical to how the sighting probability was modeled in Durban et al. (2016).


The number of gray whales that migrated through the sampling area during the $t$-th day of the season was modeled as a random Poisson variable with the mean $\bar{N}_{t, y}$, 

$$ N_{t, y} \sim POI(\bar{N}_{t,y}) $$

where $\bar{N}_t$ is the "mean" number of whales that expected to migrate through the sampling area on the $t$-th day of the season $y$ and modeled with Richards functions above. 

I used Poisson distribution for this hierarchical model based on the finding in Raftery (1988). 

The total number of gray whales for season $y$ is the sum of all $N_{t, y}$ and corrected for nighttime passage:

$$ N_y = \lambda * \sum_{t = 1} ^ {90} N_{t, y} $$ and 

$$ \lambda \sim N(1.0875, 0.03625) $$ (Perryman et al. YR). 



### Performance of the new approach

#### Simulation

To evaluate the performance of the new approach using Richards functions, I simulated data using the above relationships. 

```{r simulation, echo=FALSE, message=FALSE}
# Define Richards function parameters
S1 <- -0.9
S2 <- 1.5
P <- 48
K <- 2.5
Max <- 1000


# Define sighting probability parameters
B0 <- 0.3
B_BF <- -1.2
B_VS <- -2.3

Days <- 1:90
N.mean <- Richards_fcn(d = Days, S1 = S1, S2 = S2, K = K, P = P, min = 0, max = Max)

True.N <- array()
for (k in 1:length(N.mean)) True.N[k] <- rpois(n = 1, lambda = N.mean[k])

N <- data.frame(Day = Days,
                N.mean = N.mean,
                N.true = True.N)

if (!file.exists("RData/Pois_Binom_sim_results.rds")){
  # I use the real data to emulate sampling and sighting conditions
tmp <- readRDS(paste0("RData/V2.1_Aug2022/out_2020_Tomo_v2.rds"))
Final_Data <- tmp$Data_Out %>%
  mutate(Year = 2020,
         Day = as.numeric(BeginDay)) %>%
  mutate(effort = dur) %>%
  mutate(watch.prop = effort * 24/9) %>%
  select(Year, Day, effort, watch.prop, bf, vs, n, obs)

# Find all observers and change them into integer code:
unique.obs <- unique(Final_Data$obs)
unique.obs <- unique.obs[!is.na(unique.obs)]
obs.ID.df <- data.frame(obs = unique.obs,
                        obs.ID = 1:length(unique.obs))

Final_Data %>% 
  left_join(obs.ID.df, by = "obs") %>% 
  select(-obs) -> Final_Data

# figure out the number of periods
Final_Data %>% 
  group_by(Year) %>%
  #filter(effort > 0) %>%
  summarise(n = n()) -> periods

Final_Data$n[Final_Data$effort == 0] <- NA

# Create sighting probabilities
Final_Data %>%
  mutate(Sighting.Prob.lm = B0 + B_BF * scale(bf) + B_VS * scale(vs) + rnorm(1, 0, 1.5)) %>%
  mutate(Sighting.Prob = exp(Sighting.Prob.lm)/(1 + exp(Sighting.Prob.lm)),
         Binom.Prob = watch.prop * Sighting.Prob) -> Final_Data

Final_Data %>%
  left_join(N, by = "Day") -> Data_True.N

obs <- obsd.n <- array(dim = c(nrow(Data_True.N), 1, 1))
watch.prop <- bf <- vs <- day <- array(dim = c(nrow(Data_True.N), 1))
for (k in 1:nrow(Data_True.N)){
  obsd.n[k, 1, 1] <- rbinom(n = 1, size = Data_True.N$N.true[k], 
                      prob = Data_True.N$Binom.Prob[k])
  
  obs[k,1,1] <- Data_True.N$obs.ID[k]
  watch.prop[k, 1] <- Data_True.N$watch.prop[k]
  
  bf[k, 1] <- Data_True.N$bf[k]
  vs[k, 1] <- Data_True.N$vs[k]
  day[k, 1] <- Data_True.N$Day[k]
}

#Data_True.N$obsd.n <- obsd.n

MCMC.params <- list(n.samples = 100000,
                    n.thin = 10,
                    n.burnin = 80000,
                    n.chains = 5)

jags.model <- paste0("models/model_Richards_pois_bino.txt")

jags.params <- c("OBS.RF","OBS.Switch",
                "BF.Switch","BF.Fixed","VS.Switch",
                "VS.Fixed","mean.prob",
                "BF.Fixed",
                "VS.Fixed", "mean.N", "max",
                "Corrected.Est","Raw.Est","N",
                "K", "S1", "S2", "P", "cv.N",
                "sigma.N", "log.lkhd")

jags.data <- list(  n = obsd.n, 
                    n.station = 1,
                    n.year = 1,
                    n.obs = nrow(obs.ID.df)+1,
                    periods = periods$n,
                    obs = obs,
                    vs = vs,
                    bf = bf,
                    watch.prop = watch.prop,
                    day = day,
                    max.vec = c(1000, 1000))

jm <- jags(jags.data,
             inits = NULL,
             parameters.to.save= jags.params,
             model.file = jags.model,
             n.chains = MCMC.params$n.chains,
             n.burnin = MCMC.params$n.burnin,
             n.thin = MCMC.params$n.thin,
             n.iter = MCMC.params$n.samples,
             DIC = T, parallel=T)

jm.out <- list(jm = jm,
             jags.data = jags.data,
             jags.params = jags.params,
             jags.model = jags.model,
             MCMC.params = MCMC.params)

saveRDS(jm.out,
        file = "RData/Pois_Binom_sim_results.rds")
  
} else {
  
  jm.out <- readRDS("RData/Pois_Binom_sim_results.rds")
}



```


A quick look of the results seems to show parameters were estimated fairly well. I have to look at how N.mean etc were estimated. The run takes several minutes but not too bad so run it again and plot results. 





